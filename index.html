<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorant Proto: Multiplayer</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #0f1923; color: white; user-select: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* HUD */
        #top-hud { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; background: rgba(15, 25, 35, 0.8); padding: 5px 30px; border-bottom: 2px solid #ff4655; clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%); }
        #timer { font-size: 32px; font-weight: bold; }
        #round-state { font-size: 14px; color: #ff4655; font-weight: bold; padding-top: 10px; }
        
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .ch-h { position: absolute; width: 14px; height: 2px; background: #00ffaa; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 2px black; }
        .ch-v { position: absolute; width: 2px; height: 14px; background: #00ffaa; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 2px black; }

        #hud-bottom { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 40px; align-items: flex-end; }
        .hud-val { font-size: 48px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .hud-lbl { font-size: 12px; color: #ccc; letter-spacing: 1px; text-transform: uppercase; }
        #health-val { color: #ff4655; }
        
        /* MENU */
        #menu-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0f1923; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        .agent-select { display: flex; gap: 10px; margin: 20px 0; }
        .agent-card { width: 80px; height: 120px; background: #1f2b35; border: 2px solid #333; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: 0.2s; }
        .agent-card.selected { border-color: #00ffaa; background: #2a3b47; }
        
        #lobby-input { padding: 10px; font-size: 16px; width: 200px; text-align: center; margin-bottom: 20px; background: #333; color: white; border: 1px solid #555; }
        #start-btn { padding: 15px 50px; font-size: 20px; background: #ff4655; color: white; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; }
        
        #status-msg { margin-top: 10px; color: #888; font-size: 12px; }

        /* ALERTS */
        #alert-msg { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); font-size: 40px; font-weight: bold; text-shadow: 0 0 10px black; opacity: 0; transition: opacity 0.5s; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
            }
        }
    </script>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="top-hud">
            <div id="round-state">MULTIPLAYER PREVIEW</div>
            <div id="timer">100</div>
        </div>
        <div id="alert-msg">MATCH START</div>
        <div id="crosshair"><div class="ch-h"></div><div class="ch-v"></div></div>
        <div id="hud-bottom">
            <div><div class="hud-val" id="health-val">100</div><div class="hud-lbl">Health</div></div>
            <div><div class="hud-val" id="ammo-val">25</div><div class="hud-lbl">Ammo</div></div>
        </div>
    </div>

    <!-- Menu -->
    <div id="menu-screen">
        <h1 style="color:#ff4655; margin:0; font-size:60px; font-style:italic;">VALORANT<span style="color:white; font-size:30px;">CLONE</span></h1>
        <p style="color:#aaa;">WASD to Move, Click to Shoot. Share Lobby Name.</p>
        
        <input type="text" id="lobby-input" placeholder="Enter Lobby Name (e.g. room1)" value="room1">
        
        <div class="agent-select">
            <div class="agent-card" onclick="selectAgent('jett')"><div>ðŸ’¨</div><div>Jett</div></div>
            <div class="agent-card" onclick="selectAgent('phoenix')"><div>ðŸ”¥</div><div>Phoenix</div></div>
            <div class="agent-card" onclick="selectAgent('sage')"><div>ðŸ§Š</div><div>Sage</div></div>
        </div>
        <button id="start-btn" onclick="startGame()">Enter Game</button>
        <div id="status-msg">Checking Config...</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, where, deleteDoc } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "nMIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQCjszPW+vOZzZ3S\nZwxm+zHwap0G+ft9LcoPyDajyE0Wn+a5NPkaac5eddQH+cNW1jm8hUzirf1hH411\nAthpRYYiXsQKhT4un0lC4nu24hbK6MtX8oQe2XJ0DgM+MO/8iNYSlMhNB47wNGn2\nod0W9Li+OCw9QWqv+V8lnwCxwvAa3h+YOp2oPtjngvNykZkAfCRmjMA683TkxqqS\nudHeRYH5iyHUwQX2bnza1DV2xPQfqCvknIwssiwpD+/B4vqqiVNTANaiYVDg30tA\njoGNVjppZKOcMsYpkl2efj6oP8sdIbuzcFPqMHxaKPIeI1HPJ49I747PBsVVCjut\nvQz5707FAgMBAAECggEABUKq9cuWrGiZG7vIAD8uOaWTajf6RumDxsIOT3EOWR3G\nUklLf/fKc+qhZ6g1CMNVk6NM9zPUIpza9Nmkjq13Q/97mULy3piryARzKUtWpCqa\n7jaS3FLshKI2pHb6H0leZ7Z0QVVu2HU2uoA1FJnEngg8E7PYc9M1pYXYhd3XzWUs\nrpKTX1yiJYWNMz3ZWk58zKHW9W76g6A+kCziSlcfTBVGtB1BYWOVhJhbJ52LAOSf\nzj7ilQzdoUFq+gApweGBW/wM1z4cnvUqSZkUJ0UWzRSR5GndaO35397dUXyz5TXx\npvy8j2U5My2UcapnsCFMcJUnJM5Dg6BW7llCQgxQeQKBgQDkRmooSXjAAEg9vFkl\nU6UCNIFEoNTOt2GNhmerv5yYd0uJBUbCR7kCv+QNSRLGK7xqssSx4q6hn1XfM091\np6fCZx/22foWQbuGk3kioIrCl9+LWnxrCNVWtjZ4FsJWpfA7ETccpdmK4E5V21as\nOgiKVQIemlYdKQnDLyqioE8U5wKBgQC3lQEWkCAcC316idiXoyKbnekCnoDfuNnJ\nH1nfOXlOQURdFAp+Md+rMVHrZzq8Hz2ZdhMSdN6BSO5OYPmoQfAAkroeWW1SzZnF\nUAwpo/PRBWE9FzJdtKB8G3zfkQBTaZk1J6V1AIlwVUq7eKruse6R+VNWMpL1QK8z\n2jQDWoddcwKBgB8rslE//xoQr8ymTHH5Yv3TF5e8cnKrvclqgfuE1ahIGeti6g+b\nZZsHgueBg+vFixvyv0MfFgOB02MACaiiNRkppca6axjg7u9ocdEVpPz/agoIWBbx\nhNgrV3K8gNr+G7ilGCZ0SylYibnVkpc/8WyaQQjWwE2JDgk2BpdgVowfAoGALvTa\n6WWGAQZjWwOFNgwRHxK99eCLAC5s7kepmjI+N+jzzocAxBSHrGcaGAc4e8PV4rnT\n2QWxoAoCgmPFl+b9t3fQSVEAaIyUR2bZJZF9HLqui4yyYkuAPR5ey2RwW+WHvZPd\ne1be0K/QRLFxr0otxoKqcULQWhDof2/RnAX818cCgYAxp6NsbzFCnt62tAsQViA7\ni5I/9dm8G3K1eZGho/7WBStfduMN/l+LVD6M4s1TYyK/+juzdLO2Pop65Jk3DOSp\nH/urgYUElAgW2KbBVe1bEm1yEZlYQnvLYmexS8vv9gJLjKtJbTdUbEnU1c2DwhnT\nbatylJuZWfcjtL+x6IDVHA",
            authDomain: "valorant-48fd8.firebaseapp.com",
            projectId: "valorant-48fd8",
            storageBucket: "valorant-48fd8.firebasestorage.app",
            messagingSenderId: "462060216514",
            appId: "1:462060216514:web:ca192f3fc7d542b9391b5b",
            measurementId: "G-HD9MC806HG"
        };

        // --- SYSTEM VARIABLES ---
        let db, auth, userId;
        let remotePlayers = {}; 
        let lobbyId = "default";
        let isMultiplayer = false;

        // Initialize Firebase if keys are present
        const statusEl = document.getElementById('status-msg');
        if (firebaseConfig.apiKey && firebaseConfig.apiKey.length > 0) {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Attempt Anonymous Sign-In
                signInAnonymously(auth).then(() => {
                    statusEl.innerText = "Online: Connected to Firebase";
                    statusEl.style.color = "#00ffaa";
                    isMultiplayer = true;
                }).catch((e) => {
                    // Suppress known config errors and degrade gracefully to offline mode
                    if (e.code === 'auth/configuration-not-found' || e.code === 'auth/operation-not-allowed' || e.code === 'auth/admin-restricted-operation') {
                        statusEl.innerText = "Offline Mode (Auth Not Configured)";
                        console.warn("Firebase Auth is not enabled in Console. Running in Singleplayer.");
                    } else {
                        statusEl.innerText = "Offline: Connection Failed";
                        console.warn("Auth Error:", e.message);
                    }
                    statusEl.style.color = "#ff4655";
                    // Fallback to offline mode is automatic since isMultiplayer remains false
                });

                onAuthStateChanged(auth, (user) => {
                    if (user) userId = user.uid;
                });
            } catch (e) {
                console.warn("Firebase Init Failed:", e);
                statusEl.innerText = "Offline Mode (Config Error)";
            }
        } else {
            statusEl.innerText = "Offline Mode (No Config Provided)";
            console.log("No Firebase config found. Running in offline mode.");
        }

        // --- GAME CONSTANTS ---
        const MOVEMENT_SPEED = 10.0;
        const JUMP_FORCE = 12.0;
        const GRAVITY = 30.0;
        const PLAYER_HEIGHT = 1.6;
        const PLAYER_RADIUS = 0.5;

        const agents = {
            'jett': { color: 0xaaccff },
            'phoenix': { color: 0xffaa00 },
            'sage': { color: 0x00ffaa }
        };

        let selectedAgent = null;
        let isPlaying = false;
        let walls = []; 

        // --- THREE.JS SETUP ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.Fog(0x87CEEB, 10, 60);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        document.getElementById('canvas-container').appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);
        const dirLight = new THREE.DirectionalLight(0xffffff, 0.8);
        dirLight.position.set(50, 100, -50);
        dirLight.castShadow = true;
        dirLight.shadow.mapSize.width = 2048; 
        dirLight.shadow.mapSize.height = 2048;
        scene.add(dirLight);

        const controls = new PointerLockControls(camera, document.body);

        // --- MAP GENERATION ---
        function createBox(x, y, z, w, h, d, color) {
            const geo = new THREE.BoxGeometry(w, h, d);
            const mat = new THREE.MeshStandardMaterial({ color: color });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set(x, y + h/2, z); 
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            mesh.geometry.computeBoundingBox();
            scene.add(mesh);
            walls.push(mesh);
        }

        function createMap() {
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x444444 }));
            floor.rotation.x = -Math.PI / 2;
            floor.receiveShadow = true;
            scene.add(floor);
            
            const C_WALL = 0xd6cba8; 
            const C_BOX = 0x2e4a3d;

            // B Main
            createBox(-35, 0, 5, 30, 6, 1, C_WALL);
            createBox(-35, 0, -5, 30, 6, 1, C_WALL);
            // Site Boundaries
            createBox(0, 0, -20, 40, 8, 1, C_WALL); 
            createBox(0, 0, 20, 40, 8, 1, C_WALL);
            createBox(20, 0, 0, 1, 8, 40, C_WALL); 
            // Boxes
            createBox(-5, 0, 0, 3, 3, 3, C_BOX);
            createBox(10, 0, -10, 8, 4, 8, C_WALL); 
            createBox(5, 0, 15, 10, 2, 8, C_WALL); 
        }

        // --- INPUTS ---
        const keys = { w: false, a: false, s: false, d: false, space: false };
        document.addEventListener('keydown', (e) => {
            switch(e.code) {
                case 'KeyW': keys.w = true; break;
                case 'KeyA': keys.a = true; break;
                case 'KeyS': keys.s = true; break;
                case 'KeyD': keys.d = true; break;
                case 'Space': keys.space = true; break;
            }
        });
        document.addEventListener('keyup', (e) => {
            switch(e.code) {
                case 'KeyW': keys.w = false; break;
                case 'KeyA': keys.a = false; break;
                case 'KeyS': keys.s = false; break;
                case 'KeyD': keys.d = false; break;
                case 'Space': keys.space = false; break;
            }
        });

        // --- COLLISION LOGIC ---
        const playerBox = new THREE.Box3();

        function checkCollision(position) {
            const min = new THREE.Vector3(position.x - PLAYER_RADIUS, position.y - 1.5, position.z - PLAYER_RADIUS);
            const max = new THREE.Vector3(position.x + PLAYER_RADIUS, position.y + 0.5, position.z + PLAYER_RADIUS);
            playerBox.set(min, max);

            for (const wall of walls) {
                const wallBox = new THREE.Box3().setFromObject(wall);
                if (playerBox.intersectsBox(wallBox)) return true;
            }
            return false;
        }

        // --- GAME FUNCTIONS ---
        window.selectAgent = (agent) => {
            selectedAgent = agent;
            document.querySelectorAll('.agent-card').forEach(c => c.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        };

        window.startGame = () => {
            if (!selectedAgent) { alert("Select an Agent!"); return; }
            lobbyId = document.getElementById('lobby-input').value || "default";
            
            document.getElementById('menu-screen').style.display = 'none';
            isPlaying = true;
            
            createMap();
            
            // Gun
            const gun = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.5), new THREE.MeshStandardMaterial({color:0x333333}));
            gun.position.set(0.2, -0.2, -0.4);
            camera.add(gun);
            scene.add(camera);

            camera.position.set(-30, 2, 0);
            camera.lookAt(0, 2, 0);
            
            controls.lock();

            if (isMultiplayer && userId) {
                initMultiplayer();
            }
        };

        // --- MULTIPLAYER LOGIC ---
        function initMultiplayer() {
            // NOTE: Using a public collection 'valorant_game_data'
            const playersRef = collection(db, 'valorant_game_data');

            // 1. Listen for others in same lobby
            const q = query(playersRef, where("lobbyId", "==", lobbyId));
            onSnapshot(q, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = change.doc.data();
                    const pid = change.doc.id;
                    if (pid === userId) return; 

                    if (change.type === "added" || change.type === "modified") {
                        updateRemotePlayer(pid, data);
                    }
                    if (change.type === "removed") {
                        removeRemotePlayer(pid);
                    }
                });
            });

            // 2. Broadcast loop
            setInterval(broadcastPosition, 100); 
            
            // 3. Cleanup on unload
            window.addEventListener('beforeunload', () => {
               const myDoc = doc(db, 'valorant_game_data', userId);
               deleteDoc(myDoc);
            });
        }

        function broadcastPosition() {
            if (!isPlaying || !userId) return;
            const myDoc = doc(db, 'valorant_game_data', userId);
            const dir = new THREE.Vector3();
            camera.getWorldDirection(dir);
            const yaw = Math.atan2(dir.x, dir.z);

            setDoc(myDoc, {
                lobbyId: lobbyId,
                x: camera.position.x,
                y: camera.position.y,
                z: camera.position.z,
                yaw: yaw,
                agent: selectedAgent,
                lastUpdate: Date.now()
            }, { merge: true });
        }

        function updateRemotePlayer(id, data) {
            if (!remotePlayers[id]) {
                const group = new THREE.Group();
                const color = agents[data.agent] ? agents[data.agent].color : 0xffffff;
                const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.6, 4, 8), new THREE.MeshStandardMaterial({ color: color }));
                body.position.y = 0.8;
                group.add(body);
                const head = new THREE.Mesh(new THREE.BoxGeometry(0.3, 0.3, 0.3), new THREE.MeshStandardMaterial({color: 0xffffff}));
                head.position.y = 1.6;
                group.add(head);
                scene.add(group);
                remotePlayers[id] = group;
            }
            const p = remotePlayers[id];
            p.position.set(data.x, data.y - 1.6, data.z); 
            p.rotation.y = data.yaw;
        }

        function removeRemotePlayer(id) {
            if (remotePlayers[id]) {
                scene.remove(remotePlayers[id]);
                delete remotePlayers[id];
            }
        }

        // --- MAIN LOOP ---
        let prevTime = performance.now();
        let velocityY = 0;

        function animate() {
            requestAnimationFrame(animate);

            if (isPlaying && controls.isLocked) {
                const time = performance.now();
                const delta = (time - prevTime) / 1000;
                prevTime = time;

                const moveSpeed = MOVEMENT_SPEED * delta;
                const camDir = new THREE.Vector3();
                camera.getWorldDirection(camDir);
                camDir.y = 0; 
                camDir.normalize();

                const camRight = new THREE.Vector3();
                camRight.crossVectors(camDir, new THREE.Vector3(0, 1, 0));
                camRight.normalize();

                const moveVec = new THREE.Vector3(0, 0, 0);
                if (keys.w) moveVec.add(camDir);
                if (keys.s) moveVec.sub(camDir);
                if (keys.d) moveVec.add(camRight);
                if (keys.a) moveVec.sub(camRight);

                if (moveVec.length() > 0) {
                    moveVec.normalize().multiplyScalar(moveSpeed);
                }

                // X Collision
                const candidatePos = camera.position.clone();
                candidatePos.x += moveVec.x;
                if (!checkCollision(candidatePos)) {
                    camera.position.x += moveVec.x;
                }

                // Z Collision
                candidatePos.copy(camera.position); 
                candidatePos.z += moveVec.z;
                if (!checkCollision(candidatePos)) {
                    camera.position.z += moveVec.z;
                }

                // Gravity
                if (keys.space && camera.position.y <= PLAYER_HEIGHT + 0.1) {
                    velocityY = JUMP_FORCE;
                }

                velocityY -= GRAVITY * delta;
                camera.position.y += velocityY * delta;

                if (camera.position.y < PLAYER_HEIGHT) {
                    camera.position.y = PLAYER_HEIGHT;
                    velocityY = 0;
                }
            } else {
                prevTime = performance.now();
            }

            renderer.render(scene, camera);
        }

        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth/window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
