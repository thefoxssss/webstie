<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>What up Gooner</title>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #000;
      --accent: #ff0606;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      font-family: 'Press Start 2P', monospace;
      color: var(--accent);
      text-align: center;
      overflow: hidden;
    }
    .wrap {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
    }
    button, input {
      font-family: inherit;
      color: var(--accent);
      background: transparent;
      border: 2px solid var(--accent);
      padding: 10px;
      margin: 5px;
      border-radius: 4px;
      cursor: pointer;
    }
    #board {
      display: grid;
      grid-template-columns: repeat(3, 100px);
      grid-gap: 5px;
      justify-content: center;
      margin-top: 20px;
    }
    .cell {
      width: 100px;
      height: 100px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--accent);
      font-size: 2em;
      cursor: pointer;
    }
    #overlayTicTacToe {
      display: none;
      flex-direction: column;
      align-items: center;
    }
    #overlayTicTacToe.active {
      display: flex;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>You're cool</h1>
    <h3>v23.0 TTT</h3>

    <div id="homeScreen">
      <p>Type a secret code below</p>
      <input id="roomInput" type="text" placeholder="Room code" />
      <div>
        <button id="createBtn">Create Game</button>
        <button id="joinBtn">Join Game</button>
      </div>
      <p id="status"></p>
    </div>

    <div id="overlayTicTacToe">
      <h2 id="statusText">Waiting...</h2>
      <div id="board"></div>
      <div>
        <button id="resetBtn">RESET</button>
        <button id="closeBtn">CLOSE</button>
      </div>
    </div>
  </div>

  <script>
    let tttSocket = null;
    let tttGameState = null;
    let tttMyPlayer = null;
    let tttMySymbol = null;

    const WORKER_BASE = "wss://aiworker.thefoxsss6969.workers.dev";
    const createBtn = document.getElementById("createBtn");
    const joinBtn = document.getElementById("joinBtn");
    const roomInput = document.getElementById("roomInput");
    const status = document.getElementById("status");
    const boardEl = document.getElementById("board");
    const statusText = document.getElementById("statusText");
    const overlay = document.getElementById("overlayTicTacToe");
    const closeBtn = document.getElementById("closeBtn");
    const resetBtn = document.getElementById("resetBtn");

    createBtn.onclick = async () => {
      const resp = await fetch("https://aiworker.thefoxsss6969.workers.dev/tictactoe/create");
      const code = await resp.text();
      roomInput.value = code;
      status.innerText = `Room created: ${code}`;
    };

    joinBtn.onclick = () => {
      const code = roomInput.value.trim().toUpperCase();
      if (!code) return alert("Enter room code!");
      connectToTTTRoom(code);
    };

    closeBtn.onclick = () => window.closeTTTGame();
    resetBtn.onclick = () => window.resetTTTGame();

    function updateTTTBoard() {
      boardEl.innerHTML = "";
      tttGameState.board.forEach((cell, i) => {
        const div = document.createElement("div");
        div.className = "cell";
        div.textContent = cell || "";
        div.onclick = () => window.handleTTTCellClick(i);
        boardEl.appendChild(div);
      });
    }

    function updateTTTStatus() {
      if (tttGameState.gameOver) {
        if (tttGameState.winner === "draw") {
          statusText.textContent = "DRAW!";
        } else {
          statusText.textContent = `${tttGameState.winner} wins!`;
        }
      } else {
        const turnSymbol = tttGameState.currentPlayer === 0 ? "X" : "O";
        statusText.textContent = (turnSymbol === tttMySymbol)
          ? "Your turn!"
          : "Opponent's turn...";
      }
    }

    function connectToTTTRoom(roomCode) {
      overlay.classList.add("active");
      document.getElementById("homeScreen").style.display = "none";

      tttSocket = new WebSocket(`${WORKER_BASE}/tictactoe/join/${roomCode}`);

      tttSocket.onopen = () => console.log("Connected to room", roomCode);

      tttSocket.onmessage = (event) => {
        const data = JSON.parse(event.data);
        if (data.type === "init") {
          tttMyPlayer = data.player;
          tttMySymbol = data.symbol;
          tttGameState = data.state;
          updateTTTBoard();
          updateTTTStatus();
        } else if (data.type === "update" || data.type === "sync") {
          tttGameState = data.state;
          updateTTTBoard();
          updateTTTStatus();
        } else if (data.type === "playerLeft") {
          alert("Other player left!");
          window.closeTTTGame();
        } else if (data.type === "error") {
          alert(data.message);
          window.closeTTTGame();
        }
      };

      tttSocket.onerror = (err) => {
        console.error("TTT WebSocket error", err);
        alert("Connection failed");
        window.closeTTTGame();
      };

      tttSocket.onclose = () => console.log("TTT socket closed");
    }

    window.handleTTTCellClick = (index) => {
      if (!tttSocket || tttSocket.readyState !== WebSocket.OPEN) return;
      if (!tttGameState || tttGameState.gameOver) return;
      if (tttGameState.currentPlayer !== tttMyPlayer) return;
      if (tttGameState.board[index] !== null) return;
      tttSocket.send(JSON.stringify({ type: "move", player: tttMyPlayer, index }));
    };

    window.resetTTTGame = () => {
      if (tttSocket && tttSocket.readyState === WebSocket.OPEN) {
        tttSocket.send(JSON.stringify({ type: "reset" }));
      }
    };

    window.closeTTTGame = () => {
      overlay.classList.remove("active");
      document.getElementById("homeScreen").style.display = "block";
      if (tttSocket) {
        tttSocket.close();
        tttSocket = null;
      }
    };
  </script>
</body>
</html>
