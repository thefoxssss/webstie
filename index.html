<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pixel DOOM</title>
<style>
html,body {
  margin:0; padding:0; overflow:hidden;
  background:black; height:100%; width:100%;
}
#game {
  display:block; width:100vw; height:100vh;
  image-rendering: pixelated;
}
#hud {
  position:absolute; bottom:0; left:0; width:100%;
  text-align:center;
}
#gun {
  position:absolute; bottom:0; left:50%; transform:translateX(-50%);
  width:200px; image-rendering: pixelated;
}
</style>
</head>
<body>

<canvas id="game"></canvas>
<img id="gun" src="https://i.ibb.co/mGPW9rq/pistol.png">
<div id="hud"></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight;

// Map setup
const map = [
  [1,1,1,1,1,1,1,1,1,1,1],
  [1,0,0,0,0,0,0,0,0,0,1],
  [1,0,0,0,0,1,0,0,0,0,1],
  [1,0,0,0,0,1,0,0,0,0,1],
  [1,0,0,1,0,1,0,1,0,0,1],
  [1,0,0,1,0,0,0,1,0,0,1],
  [1,0,0,1,0,0,0,0,0,0,1],
  [1,0,0,0,0,0,0,0,0,0,1],
  [1,1,1,1,1,1,1,1,1,1,1]
];

const tileSize = 64;
let posX = 3.5, posY = 3.5;
let dir = 0;
let moveForward = false, moveBackward = false, turnLeft = false, turnRight = false;
const speed = 0.06;

// Enemies
let enemies = [
  {x:6.5, y:5.5, alive:true},
  {x:8.5, y:3.5, alive:true}
];

function castRays() {
  const w = canvas.width;
  const h = canvas.height;
  const fov = Math.PI / 3;
  const numRays = w / 2; // resolution
  const distProjPlane = (w / 2) / Math.tan(fov / 2);
  
  ctx.fillStyle = "#111";
  ctx.fillRect(0,0,w,h/2);
  ctx.fillStyle = "#333";
  ctx.fillRect(0,h/2,w,h/2);

  for(let i=0; i<numRays; i++){
    const rayScreenPos = (i - numRays/2);
    const rayAngle = dir + Math.atan(rayScreenPos / distProjPlane);
    let sin = Math.sin(rayAngle);
    let cos = Math.cos(rayAngle);

    let dist = 0;
    let hit = 0;
    while(!hit && dist < 20){
      dist += 0.05;
      let x = Math.floor(posX + cos * dist);
      let y = Math.floor(posY + sin * dist);
      if(map[y] && map[y][x] && map[y][x] != 0) hit = 1;
    }

    const wallHeight = (tileSize / dist) * distProjPlane;
    const shade = Math.max(0, 255 - dist * 30);
    ctx.fillStyle = `rgb(${shade},${shade},${shade})`;
    ctx.fillRect(i*2, (h/2)-wallHeight/2, 2, wallHeight);
  }
}

function drawEnemies(){
  const fov = Math.PI/3;
  const w = canvas.width;
  const distProjPlane = (w / 2) / Math.tan(fov / 2);

  enemies.forEach(e=>{
    if(!e.alive) return;
    const dx = e.x - posX;
    const dy = e.y - posY;
    const dist = Math.sqrt(dx*dx+dy*dy);
    const angleToEnemy = Math.atan2(dy,dx) - dir;
    const size = (tileSize / dist) * distProjPlane;

    const x = (w/2) + Math.tan(angleToEnemy)*distProjPlane - size/2;
    ctx.fillStyle = "red";
    ctx.fillRect(x, canvas.height/2 - size/2, size, size);
  });
}

function movePlayer(){
  if(turnLeft) dir -= 0.05;
  if(turnRight) dir += 0.05;
  const dx = Math.cos(dir);
  const dy = Math.sin(dir);
  if(moveForward){
    if(map[Math.floor(posY+dy*speed)][Math.floor(posX)]==0) posY += dy*speed;
    if(map[Math.floor(posY)][Math.floor(posX+dx*speed)]==0) posX += dx*speed;
  }
  if(moveBackward){
    if(map[Math.floor(posY-dy*speed)][Math.floor(posX)]==0) posY -= dy*speed;
    if(map[Math.floor(posY)][Math.floor(posX-dx*speed)]==0) posX -= dx*speed;
  }
}

function shoot(){
  // find nearest enemy in front
  const fov = Math.PI/8;
  enemies.forEach(e=>{
    if(!e.alive) return;
    const dx = e.x - posX;
    const dy = e.y - posY;
    const dist = Math.sqrt(dx*dx+dy*dy);
    const angleToEnemy = Math.atan2(dy,dx) - dir;
    if(Math.abs(angleToEnemy) < fov && dist < 5){
      e.alive = false;
    }
  });
}

function gameLoop(){
  movePlayer();
  castRays();
  drawEnemies();
  requestAnimationFrame(gameLoop);
}
gameLoop();

window.addEventListener('keydown', e=>{
  if(e.key=='w') moveForward=true;
  if(e.key=='s') moveBackward=true;
  if(e.key=='a') turnLeft=true;
  if(e.key=='d') turnRight=true;
  if(e.key==' ') shoot();
});
window.addEventListener('keyup', e=>{
  if(e.key=='w') moveForward=false;
  if(e.key=='s') moveBackward=false;
  if(e.key=='a') turnLeft=false;
  if(e.key=='d') turnRight=false;
});
</script>
</body>
</html>
