<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Valorant Proto: Spike Mode</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Segoe UI', sans-serif; background-color: #0f1923; color: white; user-select: none; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        
        /* TOP HUD */
        #top-hud { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; background: rgba(15, 25, 35, 0.85); padding: 5px 60px; border-bottom: 4px solid #ff4655; clip-path: polygon(0 0, 100% 0, 90% 100%, 10% 100%); transition: border-color 0.5s; }
        #timer { font-size: 32px; font-weight: bold; }
        #round-state { font-size: 14px; color: #ff4655; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
        
        /* SPIKE STATUS */
        #spike-hud { position: absolute; top: 80px; left: 50%; transform: translateX(-50%); text-align: center; display: none; }
        .spike-icon { font-size: 40px; margin-bottom: 5px; text-shadow: 0 0 10px #ff4655; }
        #plant-bar-container { width: 300px; height: 10px; background: #333; border: 2px solid white; border-radius: 5px; overflow: hidden; display: none; margin: 0 auto; }
        #plant-bar { height: 100%; width: 0%; background: #00ffaa; transition: width 0.1s linear; }
        
        /* ALERTS */
        #alert-msg { position: absolute; top: 20%; left: 50%; transform: translateX(-50%); font-size: 60px; font-weight: 900; text-shadow: 0 0 20px black; opacity: 0; transition: opacity 0.5s; text-align: center; white-space: nowrap; font-style: italic; }
        
        /* CROSSHAIR */
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        .ch-h { position: absolute; width: 14px; height: 2px; background: #00ffaa; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 2px black; }
        .ch-v { position: absolute; width: 2px; height: 14px; background: #00ffaa; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 2px black; }

        /* BOTTOM HUD */
        #hud-bottom { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); display: flex; gap: 40px; align-items: flex-end; }
        .hud-val { font-size: 48px; font-weight: bold; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .hud-lbl { font-size: 12px; color: #ccc; letter-spacing: 1px; text-transform: uppercase; }
        #health-val { color: #ff4655; }
        
        /* MENUS */
        .menu-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0f1923; z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: auto; }
        .val-btn { padding: 15px 40px; font-size: 18px; background: #ff4655; color: white; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; transition: 0.2s; margin: 10px; }
        .val-btn:hover { background: #d13644; }
        .val-input { padding: 12px; font-size: 16px; background: #333; border: 1px solid #555; color: white; margin: 5px; text-align: center; width: 250px; }

        /* LOBBY */
        #browser-screen { display: flex; }
        #room-list { width: 500px; height: 300px; background: rgba(0,0,0,0.3); border: 1px solid #444; overflow-y: auto; margin: 20px; padding: 10px; }
        .room-item { background: #1f2b35; padding: 15px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; border-left: 3px solid #ff4655; }
        .room-item:hover { background: #2a3b47; }
        
        /* WAITING ROOM */
        #waiting-screen { display: none; }
        .team-container { display: flex; gap: 50px; margin: 20px; }
        .team-column { width: 300px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 5px; min-height: 200px; }
        .team-header { text-align: center; font-weight: bold; margin-bottom: 10px; padding: 5px; text-transform: uppercase; letter-spacing: 2px; }
        .defenders-header { color: #00ffaa; border-bottom: 2px solid #00ffaa; }
        .attackers-header { color: #ff4655; border-bottom: 2px solid #ff4655; }
        
        .player-row { display: flex; align-items: center; background: #2a3b47; margin-bottom: 5px; padding: 5px 10px; border-radius: 3px; }
        .player-row.me { border: 1px solid #ffeb3b; }
        .p-icon { font-size: 20px; margin-right: 10px; }
        .p-name { flex-grow: 1; font-size: 14px; }

        .agent-select-mini { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; max-width: 600px; }
        .agent-opt { opacity: 0.5; cursor: pointer; border: 2px solid transparent; padding: 5px 10px; background: #333; }
        .agent-opt.selected { opacity: 1; border-color: #00ffaa; background: #444; }

        #status-msg { margin-top: 20px; color: #888; font-size: 14px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; text-align: center; max-width: 80%; }
        h1 { color:#ff4655; margin:0; font-size:60px; font-style:italic; margin-bottom: 10px; }
        h2 { color: white; text-transform: uppercase; letter-spacing: 2px; font-size: 24px; margin-bottom: 20px; }
    </style>

    <!-- Import Map -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.module.js",
                "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/",
                "firebase/app": "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js",
                "firebase/firestore": "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js",
                "firebase/auth": "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"
            }
        }
    </script>
</head>
<body>
    <div id="canvas-container"></div>

    <div id="ui-layer">
        <div id="top-hud">
            <div id="timer">0:30</div>
            <div id="round-state">BUY PHASE</div>
        </div>
        
        <div id="spike-hud">
            <div class="spike-icon">‚ò¢Ô∏è</div>
            <div style="font-weight:bold; color:white; font-size:18px; margin-bottom:5px;" id="spike-msg">CARRYING SPIKE</div>
            <div id="plant-bar-container"><div id="plant-bar"></div></div>
        </div>

        <div id="alert-msg">MATCH START</div>
        <div id="crosshair"><div class="ch-h"></div><div class="ch-v"></div></div>
        <div id="hud-bottom">
            <div><div class="hud-val" id="health-val">100</div><div class="hud-lbl">Health</div></div>
            <div><div class="hud-val" id="ammo-val">25</div><div class="hud-lbl">Ammo</div></div>
        </div>
    </div>

    <!-- 1. BROWSER SCREEN -->
    <div id="browser-screen" class="menu-overlay">
        <h1>VALORANT<span style="color:white; font-size:30px;">PROTO</span></h1>
        
        <div style="display:flex; flex-direction:row; gap: 40px; align-items: flex-start;">
            <div style="display:flex; flex-direction:column; align-items:center; background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px;">
                <h2>Create Match</h2>
                <input type="text" id="create-room-name" class="val-input" placeholder="Room Name" value="Ascent Standard">
                <input type="text" id="player-name-input" class="val-input" placeholder="Your Username" value="Player 1">
                <button class="val-btn" onclick="createRoom()">Create Room</button>
            </div>

            <div style="display:flex; flex-direction:column; align-items:center;">
                <h2>Lobby List</h2>
                <div id="room-list">
                    <div style="text-align:center; padding:20px; color:#888;">Loading rooms...</div>
                </div>
                <button class="val-btn" style="background:#444;" onclick="fetchRooms()">Refresh List</button>
            </div>
        </div>
        <div id="status-msg">Connecting to Firebase...</div>
    </div>

    <!-- 2. WAITING ROOM SCREEN -->
    <div id="waiting-screen" class="menu-overlay">
        <h1 id="lobby-title">LOBBY</h1>
        <h2 style="color:#00ffaa;" id="lobby-status">WAITING FOR PLAYERS...</h2>

        <div class="team-container">
            <div class="team-column">
                <div class="team-header attackers-header">ATTACKERS</div>
                <div id="team-attack-list"></div>
                <button class="val-btn" style="font-size:12px; padding:5px 10px; width:100%;" onclick="switchTeam('attack')">Join Attackers</button>
            </div>
            <div class="team-column">
                <div class="team-header defenders-header">DEFENDERS</div>
                <div id="team-defend-list"></div>
                <button class="val-btn" style="font-size:12px; padding:5px 10px; width:100%;" onclick="switchTeam('defend')">Join Defenders</button>
            </div>
        </div>

        <div style="margin-bottom: 5px; color: #ccc;">SELECT AGENT</div>
        <div class="agent-select-mini">
            <div class="agent-opt selected" onclick="selectAgentInLobby('jett', this)">üí® Jett</div>
            <div class="agent-opt" onclick="selectAgentInLobby('phoenix', this)">üî• Phoenix</div>
            <div class="agent-opt" onclick="selectAgentInLobby('sage', this)">üßä Sage</div>
            <div class="agent-opt" onclick="selectAgentInLobby('reyna', this)">üëÅÔ∏è Reyna</div>
            <div class="agent-opt" onclick="selectAgentInLobby('sova', this)">üèπ Sova</div>
            <div class="agent-opt" onclick="selectAgentInLobby('brim', this)">‚òÅÔ∏è Brim</div>
            <div class="agent-opt" onclick="selectAgentInLobby('omen', this)">üëª Omen</div>
            <div class="agent-opt" onclick="selectAgentInLobby('cypher', this)">üïµÔ∏è Cypher</div>
        </div>

        <button id="host-start-btn" class="val-btn" style="display:none;" onclick="hostStartGame()">START MATCH</button>
        <div id="client-wait-msg" style="color:#888; margin-top:20px;">Waiting for Host to start...</div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { PointerLockControls } from 'three/addons/controls/PointerLockControls.js';
        import { initializeApp } from 'firebase/app';
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, query, where, getDocs, arrayUnion } from 'firebase/firestore';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

        const firebaseConfig = {
            apiKey: "AIzaSyCx72zwsJ-IaVH1N7AnX9lDHgL10eDuNKY",
            authDomain: "valorant-48fd8.firebaseapp.com",
            projectId: "valorant-48fd8",
            storageBucket: "valorant-48fd8.firebasestorage.app",
            messagingSenderId: "462060216514",
            appId: "1:462060216514:web:ca192f3fc7d542b9391b5b",
            measurementId: "G-HD9MC806HG"
        };

        // --- GAME STATE ---
        let db, auth, userId;
        const mySessionId = 'sess_' + Math.random().toString(36).substr(2, 9);
        
        let currentLobbyId = null;
        let isHost = false;
        let selectedAgent = 'jett';
        let myTeam = 'attack';
        let myUsername = 'Player';
        let remotePlayers = {}; 
        let isPlaying = false;
        
        // Match State
        let gamePhase = 'waiting';
        let phaseEndTime = 0;
        let spikeState = { state: 'spawned', carrier: null, pos: null, plantTime: 0 }; 
        let barriers = []; 
        let spikeMesh = null;

        // Interaction State
        let isHoldingKey = false;
        let interactionProgress = 0;
        let currentAction = null; // 'plant', 'defuse'

        const statusEl = document.getElementById('status-msg');

        // --- INIT ---
        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, (user) => { if(user) { userId = user.uid; statusEl.innerText="Online"; statusEl.style.color="#00ffaa"; fetchRooms(); }});
                await signInAnonymously(auth);
            } catch(e) { console.error(e); statusEl.innerText="Offline: "+e.message; statusEl.style.color="#ff4655"; }
        }
        initFirebase();

        // --- LOBBY UI ---
        window.fetchRooms = async () => {
            if(!db) return;
            const q = query(collection(db, "lobbies"), where("status", "==", "waiting"));
            const snap = await getDocs(q);
            const list = document.getElementById('room-list');
            list.innerHTML = "";
            if(snap.empty) list.innerHTML = "<div style='text-align:center; color:#888; padding:20px;'>No rooms found.</div>";
            snap.forEach(d => {
                list.innerHTML += `<div class='room-item'><div><div class='room-name'>${d.data().name}</div></div><button class='join-btn' onclick="joinRoom('${d.id}')">JOIN</button></div>`;
            });
        };

        window.createRoom = async () => {
            if(!userId) return;
            const name = document.getElementById('create-room-name').value;
            myUsername = document.getElementById('player-name-input').value || "Host";
            myTeam = 'defend';
            const ref = doc(collection(db, "lobbies"));
            await setDoc(ref, {
                name, hostId: userId, status: 'waiting',
                players: [{ uid: mySessionId, name: myUsername, agent: selectedAgent, team: myTeam, isHost: true }],
                spike: { state: 'spawned', carrier: null, pos: null } // Initial spike state
            });
            enterLobby(ref.id, true);
        };

        window.joinRoom = async (rid) => {
            if(!userId) return;
            myUsername = document.getElementById('player-name-input').value || "Guest";
            myTeam = 'attack';
            const ref = doc(db, "lobbies", rid);
            await updateDoc(ref, { players: arrayUnion({ uid: mySessionId, name: myUsername, agent: selectedAgent, team: myTeam, isHost: false }) });
            enterLobby(rid, false);
        };

        window.switchTeam = (t) => { myTeam = t; updateMyPlayerData(); };
        window.selectAgentInLobby = (a, el) => {
            selectedAgent = a;
            document.querySelectorAll('.agent-opt').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            updateMyPlayerData();
        };

        async function updateMyPlayerData() {
            if(!currentLobbyId) return;
            const ref = doc(db, "lobbies", currentLobbyId);
            const snap = await getDoc(ref);
            if(!snap.exists()) return;
            let p = snap.data().players;
            const idx = p.findIndex(x => x.uid === mySessionId);
            if(idx >= 0) { p[idx].agent = selectedAgent; p[idx].team = myTeam; await updateDoc(ref, { players: p }); }
        }

        window.hostStartGame = async () => {
            if(!currentLobbyId || !isHost) return;
            const ref = doc(db, "lobbies", currentLobbyId);
            const snap = await getDoc(ref);
            // Assign spike to random attacker
            const players = snap.data().players;
            const attackers = players.filter(p => p.team === 'attack');
            let spikeCarrier = null;
            if(attackers.length > 0) {
                spikeCarrier = attackers[Math.floor(Math.random() * attackers.length)].uid;
            }

            await updateDoc(ref, { 
                status: 'playing', gamePhase: 'buy', phaseEndTime: Date.now() + 30000,
                spike: { state: 'carried', carrier: spikeCarrier, pos: null }
            });
        };

        function enterLobby(rid, h) {
            currentLobbyId = rid; isHost = h;
            document.getElementById('browser-screen').style.display = 'none';
            document.getElementById('waiting-screen').style.display = 'block';
            document.getElementById('host-start-btn').style.display = isHost ? 'block' : 'none';
            document.getElementById('client-wait-msg').style.display = isHost ? 'none' : 'block';

            onSnapshot(doc(db, "lobbies", rid), (snap) => {
                if(!snap.exists()) return;
                const d = snap.data();
                
                // Player List
                const atk = document.getElementById('team-attack-list');
                const def = document.getElementById('team-defend-list');
                atk.innerHTML = ""; def.innerHTML = "";
                const icons = { 'jett': 'üí®', 'phoenix': 'üî•', 'sage': 'üßä', 'reyna': 'üëÅÔ∏è', 'sova': 'üèπ', 'brim': '‚òÅÔ∏è', 'omen': 'üëª', 'cypher': 'üïµÔ∏è' };
                d.players.forEach(p => {
                    const html = `<div class='player-row ${p.uid===mySessionId?"me":""}'><span class='p-icon'>${icons[p.agent]}</span><span class='p-name'>${p.name}</span></div>`;
                    if(p.team === 'attack') atk.innerHTML += html; else def.innerHTML += html;
                });

                // Game Logic
                if(d.status === 'playing') {
                    if(!isPlaying) { launchGame(); }
                    
                    // Phase Sync
                    if(d.gamePhase !== gamePhase) {
                        gamePhase = d.gamePhase;
                        phaseEndTime = d.phaseEndTime;
                        handlePhaseChange();
                    }
                    
                    // Spike Sync
                    if(d.spike) handleSpikeUpdate(d.spike);
                }
            });
        }

        function launchGame() {
            document.getElementById('waiting-screen').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'block';
            isPlaying = true;
            create3DScene();
            initGameMultiplayer();
            handlePhaseChange();
        }

        function handlePhaseChange() {
            const st = document.getElementById('round-state');
            const msg = document.getElementById('alert-msg');
            
            if(gamePhase === 'buy') {
                st.innerText = "BUY PHASE"; st.style.color = "#fff";
                msg.innerText = "BUY PHASE"; msg.style.opacity = 1; setTimeout(()=>msg.style.opacity=0, 2000);
            } else if(gamePhase === 'action') {
                st.innerText = "ACTION"; st.style.color = "#ff4655";
                msg.innerText = "BARRIERS DOWN"; msg.style.opacity = 1; setTimeout(()=>msg.style.opacity=0, 2000);
                barriers.forEach(b => { scene.remove(b); walls = walls.filter(w=>w!==b); });
                barriers = [];
            } else if(gamePhase === 'planted') {
                st.innerText = "SPIKE PLANTED"; st.style.color = "#ff0000";
                msg.innerText = "SPIKE PLANTED"; msg.style.color = "#ff0000"; msg.style.opacity = 1; setTimeout(()=>msg.style.opacity=0, 3000);
                // Timer now counts UP to detonation (45s)
            } else if(gamePhase === 'defused') {
                msg.innerText = "DEFENDERS WIN"; msg.style.color = "#00ffaa"; msg.style.opacity = 1;
                isPlaying = false; setTimeout(()=>location.reload(), 5000);
            } else if(gamePhase === 'detonated') {
                msg.innerText = "ATTACKERS WIN"; msg.style.color = "#ff4655"; msg.style.opacity = 1;
                isPlaying = false; setTimeout(()=>location.reload(), 5000);
            }
        }

        function handleSpikeUpdate(newSpike) {
            spikeState = newSpike;
            
            // UI Logic
            const hud = document.getElementById('spike-hud');
            const txt = document.getElementById('spike-msg');
            
            if (spikeState.carrier === mySessionId) {
                hud.style.display = 'block';
                txt.innerText = "YOU HAVE THE SPIKE";
                txt.style.color = "#ffffff";
            } else if (spikeState.state === 'planted') {
                hud.style.display = 'block';
                txt.innerText = "‚ö†Ô∏è SPIKE PLANTED ‚ö†Ô∏è";
                txt.style.color = "#ff4655";
                
                // Show physical spike
                if(!spikeMesh && scene) {
                    const geo = new THREE.CylinderGeometry(0.2, 0.4, 0.8, 16);
                    const mat = new THREE.MeshStandardMaterial({color:0xff0000, emissive:0xff0000, emissiveIntensity:0.5});
                    spikeMesh = new THREE.Mesh(geo, mat);
                    spikeMesh.position.set(spikeState.pos.x, spikeState.pos.y, spikeState.pos.z);
                    scene.add(spikeMesh);
                    
                    // Add light
                    const light = new THREE.PointLight(0xff0000, 1, 10);
                    light.position.set(spikeState.pos.x, spikeState.pos.y+1, spikeState.pos.z);
                    scene.add(light);
                }
            } else {
                hud.style.display = 'none';
            }
        }

        // --- GAMEPLAY ACTIONS ---
        function checkActions() {
            if (!isPlaying || !camera) return;
            const hud = document.getElementById('spike-hud');
            const txt = document.getElementById('spike-msg');
            const barCont = document.getElementById('plant-bar-container');
            const bar = document.getElementById('plant-bar');
            
            const pos = camera.position;
            
            // ATTACKER: Plant
            if (myTeam === 'attack' && spikeState.carrier === mySessionId && gamePhase === 'action') {
                // Check if in Site A or B (Simple box check)
                const inSiteA = (pos.x < -20 && pos.x > -40 && pos.z > -10 && pos.z < 10);
                const inSiteB = (pos.x > 20 && pos.x < 40 && pos.z > -10 && pos.z < 10);
                
                if (inSiteA || inSiteB) {
                    hud.style.display = 'block';
                    txt.innerText = "HOLD [4] TO PLANT";
                    
                    if (isHoldingKey) {
                        currentAction = 'plant';
                        barCont.style.display = 'block';
                        interactionProgress += 0.016; // Approx 1 frame
                        bar.style.width = (interactionProgress / 4) * 100 + "%"; // 4 seconds
                        
                        if (interactionProgress >= 4) {
                            completePlant(pos);
                            interactionProgress = 0;
                            isHoldingKey = false;
                        }
                    } else {
                        barCont.style.display = 'none';
                        interactionProgress = 0;
                    }
                    return; // Exit so we don't clear UI
                }
            }

            // DEFENDER: Defuse
            if (myTeam === 'defend' && spikeState.state === 'planted') {
                const dist = pos.distanceTo(new THREE.Vector3(spikeState.pos.x, spikeState.pos.y, spikeState.pos.z));
                if (dist < 3) {
                    hud.style.display = 'block';
                    txt.innerText = "HOLD [4] TO DEFUSE";
                    
                    if (isHoldingKey) {
                        currentAction = 'defuse';
                        barCont.style.display = 'block';
                        bar.style.backgroundColor = "#00aaff";
                        interactionProgress += 0.016;
                        bar.style.width = (interactionProgress / 7) * 100 + "%"; // 7 seconds
                        
                        if (interactionProgress >= 7) {
                            completeDefuse();
                            interactionProgress = 0;
                            isHoldingKey = false;
                        }
                    } else {
                        barCont.style.display = 'none';
                        interactionProgress = 0;
                    }
                    return;
                }
            }
            
            // Reset if nothing happening
            if (spikeState.carrier !== mySessionId && spikeState.state !== 'planted') {
                hud.style.display = 'none';
            }
        }

        async function completePlant(pos) {
            const ref = doc(db, "lobbies", currentLobbyId);
            await updateDoc(ref, {
                gamePhase: 'planted',
                phaseEndTime: Date.now() + 45000, // 45s timer
                spike: { state: 'planted', carrier: null, pos: {x:pos.x, y:0.4, z:pos.z}, plantTime: Date.now() }
            });
        }

        async function completeDefuse() {
            const ref = doc(db, "lobbies", currentLobbyId);
            await updateDoc(ref, { gamePhase: 'defused' });
        }

        // --- 3D ENGINE ---
        const MOVEMENT_SPEED = 10.0;
        const JUMP_FORCE = 12.0;
        const GRAVITY = 30.0;
        const PLAYER_HEIGHT = 1.6;
        const PLAYER_RADIUS = 0.5;

        const agentsConfig = { 'jett': { color: 0xaaccff }, 'phoenix': { color: 0xffaa00 }, 'sage': { color: 0x00ffaa }, 'reyna': { color: 0xaa00aa }, 'sova': { color: 0x00aaff }, 'brim': { color: 0xff8800 }, 'omen': { color: 0x4444aa }, 'cypher': { color: 0xeeeeee } };

        function create3DScene() {
            scene = new THREE.Scene(); scene.background = new THREE.Color(0x87CEEB); scene.fog = new THREE.Fog(0x87CEEB, 10, 80);
            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true }); renderer.setSize(window.innerWidth, window.innerHeight); renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dirLight = new THREE.DirectionalLight(0xffffff, 0.8); dirLight.position.set(50, 100, -50); dirLight.castShadow = true; scene.add(dirLight);
            controls = new PointerLockControls(camera, document.body);
            createMap();
            // Gun
            const gun = new THREE.Mesh(new THREE.BoxGeometry(0.1, 0.15, 0.5), new THREE.MeshStandardMaterial({color:0x333333})); gun.position.set(0.2, -0.2, -0.4); camera.add(gun); scene.add(camera);
            // Spawn
            if (myTeam === 'attack') { camera.position.set(0, 2, 40); camera.lookAt(0, 2, 0); } else { camera.position.set(0, 2, -40); camera.lookAt(0, 2, 0); }
            document.addEventListener('click', () => { if(isPlaying) controls.lock(); });
            animate();
        }

        function createBox(x, y, z, w, h, d, color, isBarrier=false) {
            const geo = new THREE.BoxGeometry(w, h, d); const mat = new THREE.MeshStandardMaterial({ color: color, transparent: isBarrier, opacity: isBarrier ? 0.5 : 1.0 });
            const mesh = new THREE.Mesh(geo, mat); mesh.position.set(x, y + h/2, z); mesh.castShadow = !isBarrier; mesh.receiveShadow = !isBarrier; mesh.geometry.computeBoundingBox();
            scene.add(mesh); walls.push(mesh); if (isBarrier) barriers.push(mesh);
        }

        function createMap() {
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(200, 200), new THREE.MeshStandardMaterial({ color: 0x444444 })); floor.rotation.x = -Math.PI / 2; floor.receiveShadow = true; scene.add(floor);
            const C_WALL = 0xd6cba8, C_BOX = 0x2e4a3d, C_SITE = 0x888888, C_BARRIER = 0x00aaff;
            // Site A
            createBox(-30, 0, 0, 20, 1, 20, C_SITE); createBox(-30, 0, 0, 4, 3, 4, C_BOX); createBox(-40, 0, 0, 1, 6, 30, C_WALL); createBox(-20, 0, -15, 10, 6, 1, C_WALL);
            // Site B
            createBox(30, 0, 0, 20, 1, 20, C_SITE); createBox(30, 0, 0, 4, 3, 4, C_BOX); createBox(40, 0, 0, 1, 6, 30, C_WALL); createBox(30, 0, 15, 8, 4, 8, C_WALL);
            // Mid
            createBox(0, 0, 0, 10, 6, 10, C_WALL);
            // Spawns
            createBox(0, 0, 45, 60, 4, 1, C_WALL); createBox(0, 0, -45, 60, 4, 1, C_WALL);
            // Barriers
            createBox(-30, 0, 12, 10, 6, 1, C_BARRIER, true); createBox(30, 0, 12, 10, 6, 1, C_BARRIER, true); createBox(0, 0, 10, 15, 6, 1, C_BARRIER, true);
        }

        function initGameMultiplayer() {
            const q = query(collection(db, 'valorant_game_data'), where("lobbyId", "==", currentLobbyId));
            onSnapshot(q, (snap) => {
                snap.docChanges().forEach((ch) => {
                    const d = ch.doc.data(); const id = ch.doc.id;
                    if (id === mySessionId) return;
                    if (ch.type === "added" || ch.type === "modified") updateRemotePlayer(id, d);
                    if (ch.type === "removed") removeRemotePlayer(id);
                });
            });
            setInterval(broadcastPosition, 50);
            window.addEventListener('beforeunload', () => { deleteDoc(doc(db, 'valorant_game_data', mySessionId)); });
        }

        function broadcastPosition() {
            if (!isPlaying || !userId) return;
            const dir = new THREE.Vector3(); camera.getWorldDirection(dir);
            setDoc(doc(db, 'valorant_game_data', mySessionId), {
                lobbyId: currentLobbyId, x: camera.position.x, y: camera.position.y, z: camera.position.z, yaw: Math.atan2(dir.x, dir.z),
                agent: selectedAgent, team: myTeam, lastUpdate: Date.now()
            }, { merge: true });
        }

        function updateRemotePlayer(id, data) {
            if (!remotePlayers[id]) {
                const group = new THREE.Group();
                const color = agentsConfig[data.agent] ? agentsConfig[data.agent].color : 0xffffff;
                const body = new THREE.Mesh(new THREE.CapsuleGeometry(0.4, 1.6, 4, 8), new THREE.MeshStandardMaterial({ color: color })); body.position.y = 0.8; group.add(body);
                const ring = new THREE.Mesh(new THREE.RingGeometry(0.5, 0.6, 16), new THREE.MeshBasicMaterial({ color: data.team === myTeam ? 0x00ffaa : 0xff4655, side: THREE.DoubleSide })); ring.rotation.x = -Math.PI/2; ring.position.y = 0.1; group.add(ring);
                scene.add(group); remotePlayers[id] = group;
            }
            const p = remotePlayers[id]; p.position.set(data.x, data.y - 1.6, data.z); p.rotation.y = data.yaw;
        }

        function removeRemotePlayer(id) { if (remotePlayers[id]) { scene.remove(remotePlayers[id]); delete remotePlayers[id]; } }

        const keys = { w:0, a:0, s:0, d:0, space:0 };
        document.addEventListener('keydown', (e) => { if(e.code==='KeyW')keys.w=1; if(e.code==='KeyA')keys.a=1; if(e.code==='KeyS')keys.s=1; if(e.code==='KeyD')keys.d=1; if(e.code==='Space')keys.space=1; if(e.code==='Digit4') isHoldingKey=true; });
        document.addEventListener('keyup', (e) => { if(e.code==='KeyW')keys.w=0; if(e.code==='KeyA')keys.a=0; if(e.code==='KeyS')keys.s=0; if(e.code==='KeyD')keys.d=0; if(e.code==='Space')keys.space=0; if(e.code==='Digit4') isHoldingKey=false; });

        let prevTime = performance.now(); let velocityY = 0;
        function animate() {
            requestAnimationFrame(animate);
            if (!isPlaying) return;

            // Timer & Game State
            const timeEl = document.getElementById('timer');
            if (gamePhase === 'buy' || gamePhase === 'action' || gamePhase === 'planted') {
                let timeLeft = 0;
                if(gamePhase === 'planted') timeLeft = Math.max(0, Math.ceil((phaseEndTime - Date.now()) / 1000)); // Countdown to boom
                else if(gamePhase === 'buy') timeLeft = Math.max(0, Math.ceil((phaseEndTime - Date.now()) / 1000)); // Countdown to action
                else if(gamePhase === 'action') timeLeft = 100; // Static for prototype
                
                timeEl.innerText = `0:${timeLeft < 10 ? '0' : ''}${timeLeft}`;
                
                // Triggers
                if (isHost && gamePhase === 'buy' && timeLeft <= 0) updateDoc(doc(db,"lobbies",currentLobbyId), { gamePhase: 'action' });
                if (isHost && gamePhase === 'planted' && timeLeft <= 0) updateDoc(doc(db,"lobbies",currentLobbyId), { gamePhase: 'detonated' });
            }

            checkActions();

            if (!controls.isLocked) return;
            const time = performance.now(); const delta = (time - prevTime) / 1000; prevTime = time;
            const moveSpeed = MOVEMENT_SPEED * delta;
            const camDir = new THREE.Vector3(); camera.getWorldDirection(camDir); camDir.y = 0; camDir.normalize();
            const camRight = new THREE.Vector3(); camRight.crossVectors(camDir, new THREE.Vector3(0, 1, 0)); camRight.normalize();
            const moveVec = new THREE.Vector3(0, 0, 0);
            if (keys.w) moveVec.add(camDir); if (keys.s) moveVec.sub(camDir);
            if (keys.d) moveVec.add(camRight); if (keys.a) moveVec.sub(camRight);
            if (moveVec.length() > 0) moveVec.normalize().multiplyScalar(moveSpeed);
            const candidatePos = camera.position.clone(); candidatePos.x += moveVec.x; if (!checkCollision(candidatePos)) camera.position.x += moveVec.x;
            candidatePos.copy(camera.position); candidatePos.z += moveVec.z; if (!checkCollision(candidatePos)) camera.position.z += moveVec.z;
            if (keys.space && camera.position.y <= PLAYER_HEIGHT + 0.1) velocityY = JUMP_FORCE;
            velocityY -= GRAVITY * delta; camera.position.y += velocityY * delta;
            if (camera.position.y < PLAYER_HEIGHT) { camera.position.y = PLAYER_HEIGHT; velocityY = 0; }
            renderer.render(scene, camera);
        }
        window.addEventListener('resize', () => { if(camera) { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }});
    </script>
</body>
</html>
