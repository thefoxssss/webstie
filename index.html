// proxy.js
// Minimal authenticated HTTP/HTTPS forward proxy using Node.js builtins.
// Usage:
//   PROXY_USER=myuser PROXY_PASS=mypassword PROXY_PORT=3128 node proxy.js
// Defaults: user=proxy pass=changeme port=3128 host=0.0.0.0

const http = require('http');
const https = require('https');
const net = require('net');
const url = require('url');

const USER = process.env.PROXY_USER || 'proxy';
const PASS = process.env.PROXY_PASS || 'changeme';
const PORT = parseInt(process.env.PROXY_PORT || '3128', 10);
const HOST = process.env.PROXY_HOST || '0.0.0.0';
const MAX_BODY_SIZE = 50 * 1024 * 1024; // 50MB

function send407(res) {
  res.writeHead(407, {
    'Proxy-Authenticate': 'Basic realm="Proxy"',
    'Content-Type': 'text/plain'
  });
  res.end('Proxy authentication required\n');
}

function parseAuth(header) {
  if (!header) return null;
  const parts = header.split(' ');
  if (parts.length !== 2) return null;
  if (parts[0].toLowerCase() !== 'basic') return null;
  try {
    const decoded = Buffer.from(parts[1], 'base64').toString('utf8');
    const idx = decoded.indexOf(':');
    if (idx === -1) return null;
    return { user: decoded.slice(0, idx), pass: decoded.slice(idx + 1) };
  } catch (e) {
    return null;
  }
}

function checkAuth(req) {
  const header = req.headers['proxy-authorization'] || req.headers['authorization'];
  const creds = parseAuth(header);
  if (!creds) return false;
  return creds.user === USER && creds.pass === PASS;
}

const server = http.createServer();

// Handle normal HTTP requests (absolute-form expected when using a proxy)
server.on('request', (req, res) => {
  try {
    if (!checkAuth(req)) return send407(res);

    const parsed = url.parse(req.url);
    if (!parsed.hostname) {
      res.writeHead(400, { 'Content-Type': 'text/plain' });
      return res.end('Bad request: expected absolute-form URL when using this proxy\n');
    }

    const isHttps = parsed.protocol === 'https:';
    const targetPort = parsed.port ? parseInt(parsed.port, 10) : (isHttps ? 443 : 80);
    const requestOptions = {
      hostname: parsed.hostname,
      port: targetPort,
      path: parsed.path,
      method: req.method,
      headers: Object.assign({}, req.headers)
    };

    // Remove hop-by-hop headers
    delete requestOptions.headers['proxy-authorization'];
    delete requestOptions.headers['proxy-connection'];
    delete requestOptions.headers['connection'];
    delete requestOptions.headers['keep-alive'];
    delete requestOptions.headers['transfer-encoding'];
    delete requestOptions.headers['upgrade'];

    const proxyReq = (isHttps ? https : http).request(requestOptions, (proxyRes) => {
      // forward status and headers
      res.writeHead(proxyRes.statusCode, proxyRes.headers);
      proxyRes.pipe(res, { end: true });
    });

    proxyReq.on('error', (err) => {
      if (!res.headersSent) res.writeHead(502, { 'Content-Type': 'text/plain' });
      res.end('Bad gateway: ' + String(err.message) + '\n');
    });

    // body streaming with simple guard
    let received = 0;
    req.on('data', (chunk) => {
      received += chunk.length;
      if (received > MAX_BODY_SIZE) {
        proxyReq.destroy();
        req.pause();
        req.destroy();
      } else {
        proxyReq.write(chunk);
      }
    });
    req.on('end', () => proxyReq.end());
  } catch (e) {
    res.writeHead(500);
    res.end('Internal proxy error\n');
  }
});

// Handle CONNECT for HTTPS (tunneling)
server.on('connect', (req, clientSocket, head) => {
  // For CONNECT, write the 407 directly to the socket if unauthorized
  if (!checkAuth(req)) {
    clientSocket.write('HTTP/1.1 407 Proxy Authentication Required\r\nProxy-Authenticate: Basic realm="Proxy"\r\n\r\n');
    clientSocket.end();
    return;
  }

  const [host, portStr] = req.url.split(':');
  const port = parseInt(portStr || '443', 10);

  const serverSocket = net.connect(port, host, () => {
    clientSocket.write('HTTP/1.1 200 Connection Established\r\n\r\n');
    if (head && head.length) serverSocket.write(head);
    serverSocket.pipe(clientSocket);
    clientSocket.pipe(serverSocket);
  });

  serverSocket.on('error', (err) => {
    clientSocket.write('HTTP/1.1 502 Bad Gateway\r\n\r\n');
    clientSocket.end();
  });
});

server.on('clientError', (err, socket) => {
  try { socket.end('HTTP/1.1 400 Bad Request\r\n\r\n'); } catch (_) {}
});

server.listen(PORT, HOST, () => {
  console.log(`Proxy listening on ${HOST}:${PORT}`);
  console.log(`Auth -> user: ${USER}`);
  if (PASS === 'changeme') {
    console.warn('WARNING: Using default password "changeme". Set PROXY_PASS env var to something strong before exposing publicly.');
  }
});
