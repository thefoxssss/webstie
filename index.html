<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>GOONER TERMINAL V3.2 (GOLD)</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">

<style>
    :root {
        --bg: #050505;
        --scanline: rgba(18, 16, 16, 0.5);
        --accent: #ff0606;
        --accent-dim: rgba(255, 6, 6, 0.2);
        --accent-glow: rgba(255, 6, 6, 0.6);
        --text: #ff3333;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    html, body {
        height: 100%;
        margin: 0;
        background-color: var(--bg);
        font-family: "Press Start 2P", monospace;
        overflow: hidden;
        color: var(--accent);
        user-select: none;
    }

    /* CRT Effects */
    body::before {
        content: " ";
        display: block;
        position: absolute;
        top: 0; left: 0; bottom: 0; right: 0;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        z-index: 99999;
        background-size: 100% 2px, 3px 100%;
        pointer-events: none;
        animation: flicker 0.15s infinite;
    }
    body::after {
        content: " ";
        display: block;
        position: absolute;
        top: 0; left: 0; bottom: 0; right: 0;
        background: radial-gradient(circle, rgba(0,0,0,0) 60%, rgba(0,0,0,0.8) 100%);
        z-index: 99999;
        pointer-events: none;
    }
    @keyframes flicker { 0% { opacity: 0.95; } 50% { opacity: 0.85; } 100% { opacity: 0.98; } }

    /* UI Layout */
    .wrap {
        height: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
    }
    .top-menu { position: fixed; top: 20px; right: 20px; z-index: 2000; }
    .menu-btn {
        background: rgba(0, 0, 0, 0.9); color: var(--accent); padding: 12px 20px;
        font-family: "Press Start 2P", monospace; font-size: 12px; border: 2px solid var(--accent);
        cursor: pointer; box-shadow: 0 0 10px var(--accent-dim);
    }
    .menu-btn:hover { background: var(--accent-dim); box-shadow: 0 0 15px var(--accent-glow); }
    
    .dropdown-content {
        display: none; position: absolute; right: 0; top: 100%; background: #000;
        min-width: 200px; border: 2px solid var(--accent); border-top: none;
        z-index: 2001;
    }
    .dropdown-content.show { display: block; }
    .dropdown-content button {
        background: transparent; color: var(--accent); padding: 15px; width: 100%;
        text-align: left; border: none; border-bottom: 1px solid rgba(255, 0, 0, 0.2);
        font-family: inherit; font-size: 10px; cursor: pointer;
    }
    .dropdown-content button:hover { background: var(--accent); color: #000; }

    .gooner-btn {
        font-size: clamp(24px, 8vw, 72px); color: var(--accent); cursor: pointer;
        padding: 30px 40px; border: 4px solid var(--accent); background: rgba(0,0,0,0.8);
        box-shadow: 0 0 15px var(--accent-dim); text-shadow: 0 0 10px var(--accent);
        transition: all 0.2s ease; margin-bottom: 40px;
    }
    .gooner-btn:hover { transform: scale(1.05); background: var(--accent); color: #000; }
    .subtitle { color: var(--accent); font-size: 10px; opacity: 0.7; margin-top: -20px; letter-spacing: 2px; }

    .overlay {
        position: fixed; inset: 0; background: #000; display: none;
        flex-direction: column; align-items: center; justify-content: center; z-index: 1000;
    }
    .overlay.active { display: flex; }
    .close-btn {
        position: absolute; top: 20px; right: 20px; background: transparent;
        border: 2px solid var(--accent); color: var(--accent); padding: 8px 12px;
        font-family: inherit; font-size: 12px; cursor: pointer; z-index: 1001;
    }
    .close-btn:hover { background: var(--accent); color: #000; }

    canvas { border: 4px solid var(--accent); background: #000; max-width: 95vw; max-height: 70vh; }
    
    .touch-controls { display: none; margin-top: 20px; gap: 10px; }
    .touch-controls.active { display: grid; grid-template-columns: repeat(3, 1fr); }
    .touch-btn {
        width: 50px; height: 50px; border: 2px solid var(--accent); color: var(--accent);
        display: flex; align-items: center; justify-content: center; font-size: 20px;
        background: rgba(255, 6, 6, 0.1); border-radius: 8px;
    }
    @media (pointer: coarse) { .touch-controls.active { display: grid; } }

    .menu-box {
        background: rgba(20,0,0,0.9); border: 2px solid var(--accent); padding: 20px;
        display: flex; flex-direction: column; gap: 15px; text-align: center; min-width: 300px;
    }
    .term-input { background: transparent; border: 2px solid var(--accent); color: var(--accent); padding: 10px; font-family: inherit; text-align: center; font-size: 16px; }
    .term-btn { background: var(--accent); color: #000; border: none; padding: 12px; font-family: inherit; cursor: pointer; font-weight: bold; }
    .term-btn:hover { opacity: 0.8; }

    /* TIC TAC TOE */
    .ttt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; background: var(--accent); border: 5px solid var(--accent); margin-top: 10px; }
    .ttt-cell { width: 80px; height: 80px; background: #000; display: flex; align-items: center; justify-content: center; font-size: 40px; cursor: pointer; }

    /* BLACKJACK V3.2 (ROUND TABLE) */
    .bj-container {
        position: relative; width: 100%; height: 85vh;
        display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
    }
    .bj-round-table {
        position: relative; width: 100%; max-width: 900px; height: 100%;
        border-top: 2px dashed rgba(255, 6, 6, 0.3);
        border-radius: 50% 50% 0 0; display: flex; justify-content: center;
    }
    
    /* Dealer */
    .bj-dealer-zone { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; }

    /* Seats */
    .bj-seat { position: absolute; display: flex; flex-direction: column; align-items: center; width: 140px; transition: 0.5s; }
    .bj-seat-label { background: #000; color: var(--accent); font-size: 10px; padding: 2px 5px; border: 1px solid var(--accent-dim); margin-bottom: 4px; }
    .bj-seat.active-turn .bj-seat-label { background: var(--accent); color: #000; }
    .bj-seat-status { font-size: 10px; color: #ffcc00; margin-top: 4px; min-height: 14px; text-shadow: 1px 1px #000; }

    /* Seat Positions */
    .bj-my-seat { bottom: 140px; left: 50%; transform: translateX(-50%); z-index: 20; }
    .seat-pos-1 { top: 120px; left: 8%; transform: scale(0.9); }
    .seat-pos-2 { top: 120px; right: 8%; transform: scale(0.9); }
    .seat-pos-3 { top: 70px; left: 50%; transform: translateX(-50%) scale(0.9); }

    /* Cards - PIXEL STYLE V2 */
    .bj-hand { display: flex; gap: 5px; justify-content: center; min-height: 84px; }
    .bj-card {
        width: 60px; height: 84px;
        border: 2px solid var(--accent);
        display: flex; flex-direction: column; justify-content: space-between;
        padding: 4px; font-size: 14px; background: #000;
        box-shadow: 2px 2px 0px var(--accent-dim); user-select: none;
        animation: flyIn 0.3s ease-out forwards;
    }
    .bj-card.hidden {
        background: repeating-linear-gradient(45deg, #000, #000 5px, var(--accent) 5px, var(--accent) 10px);
        justify-content: center; align-items: center;
    }
    @keyframes flyIn { 0% { transform: translateY(-50px) scale(0.8); opacity: 0; } 100% { transform: translateY(0) scale(1); opacity: 1; } }

    /* HUD */
    .bj-hud {
        position: fixed; bottom: 0; left: 0; width: 100%; background: #000;
        border-top: 2px solid var(--accent); padding: 15px;
        display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 100;
    }
    .bj-info-bar { display: flex; gap: 20px; font-size: 12px; color: #fff; }
    .bj-actions, .bj-chip-rack { display: flex; gap: 10px; }
    .bj-chip {
        width: 45px; height: 45px; border-radius: 50%; border: 2px solid var(--accent);
        display: flex; align-items: center; justify-content: center; font-size: 10px;
        cursor: pointer; background: #000; color: var(--accent);
    }
    .bj-chip:active { transform: scale(0.9); background: var(--accent); color: #000; }

    /* Falling Cards */
    .falling-card {
        position: fixed; width: 40px; height: 56px;
        background: repeating-linear-gradient(45deg, #000, #000 5px, var(--accent) 5px, var(--accent) 8px);
        border: 2px solid var(--accent); z-index: 9999; pointer-events: none;
    }
</style>
</head>
<body>

<div class="version-tag">SYS.V.3.2 // GOLD_EDITION</div>

<div class="top-menu">
    <button class="menu-btn" id="menuToggle">GAMES ▼</button>
    <div class="dropdown-content" id="menuDropdown">
        <button data-game-trigger="pong">PONG</button>
        <button data-game-trigger="snake">SNAKE</button>
        <button data-game-trigger="runner">RUNNER</button>
        <button data-game-trigger="blackjack" style="border-top: 2px solid var(--accent);">BLACKJACK (NET)</button>
        <button data-game-trigger="ttt">TIC TAC TOE (ONLINE)</button>
    </div>
</div>

<div class="wrap">
    <div class="gooner-btn" id="mainBtn">GOONER</div>
    <div class="subtitle">SELECT GAME FROM MENU ↗</div>
</div>

<div class="overlay" id="overlayPong">
    <button class="close-btn" data-close="overlayPong">ABORT</button>
    <h1>PONG</h1>
    <div style="margin-bottom:10px; font-size:12px;" id="pongScore">0 : 0</div>
    <canvas id="pongCanvas" width="800" height="600"></canvas>
    <div style="margin-top:10px;">
        <button class="close-btn" style="position:static;" onclick="window.setPongDiff('easy')">EASY</button>
        <button class="close-btn" style="position:static;" onclick="window.setPongDiff('hard')">HARD</button>
    </div>
    <div class="touch-controls" id="pongControls">
        <div></div><div class="touch-btn" data-key="up">▲</div><div></div><div></div><div></div><div></div><div></div><div class="touch-btn" data-key="down">▼</div><div></div>
    </div>
</div>

<div class="overlay" id="overlaySnake">
    <button class="close-btn" data-close="overlaySnake">ABORT</button>
    <h1>SNAKE</h1>
    <div style="margin-bottom:10px;">SCORE: <span id="snakeScoreVal">0</span></div>
    <canvas id="snakeCanvas" width="600" height="400"></canvas>
    <div class="touch-controls active" id="snakeControls" style="margin-top:20px;">
        <div></div><div class="touch-btn" data-snake-key="up">▲</div><div></div><div class="touch-btn" data-snake-key="left">◀</div><div class="touch-btn" data-snake-key="down">▼</div><div class="touch-btn" data-snake-key="right">▶</div>
    </div>
</div>

<div class="overlay" id="overlayRunner">
    <button class="close-btn" data-close="overlayRunner">ABORT</button>
    <h1>RUNNER</h1>
    <div style="margin-bottom:10px;" id="runnerScoreBoard">SCORE: 0</div>
    <canvas id="runnerCanvas" width="800" height="400"></canvas>
    <div class="mobile-hint active" style="margin-top:10px;">TAP / SWIPE</div>
</div>

<div class="overlay" id="overlayTTT">
    <button class="close-btn" data-close="overlayTTT">DISCONNECT</button>
    <h1>TIC TAC TOE</h1>
    <div id="tttMenu" class="ttt-container">
        <div class="menu-box">
            <p>MULTIPLAYER LOBBY</p>
            <button class="term-btn" id="btnCreateRoom">CREATE ROOM</button>
            <p>- OR -</p>
            <input type="text" id="joinRoomCode" class="term-input" placeholder="CODE" maxlength="4">
            <button class="term-btn" id="btnJoinRoom">JOIN ROOM</button>
        </div>
        <div style="font-size:10px; margin-top:10px;">STATUS: <span id="authStatus" style="color:yellow;">CONNECTING...</span></div>
    </div>
    <div id="tttGame" class="ttt-container" style="display:none;">
        <div class="ttt-status" id="tttStatus">WAITING...</div>
        <div class="ttt-grid" id="tttGrid">
            <div class="ttt-cell" data-idx="0"></div><div class="ttt-cell" data-idx="1"></div><div class="ttt-cell" data-idx="2"></div>
            <div class="ttt-cell" data-idx="3"></div><div class="ttt-cell" data-idx="4"></div><div class="ttt-cell" data-idx="5"></div>
            <div class="ttt-cell" data-idx="6"></div><div class="ttt-cell" data-idx="7"></div><div class="ttt-cell" data-idx="8"></div>
        </div>
        <div style="font-size:20px; letter-spacing:5px;" id="displayRoomCode"></div>
    </div>
</div>

<div class="overlay" id="overlayBlackjack">
    <button class="close-btn" data-close="overlayBlackjack">ABORT</button>
    
    <div id="bjLobbyContainer" style="display:flex; flex-direction:column; align-items:center; width:100%; max-width:400px;">
        <h1 style="margin-bottom:20px;">NET RUN</h1>
        
        <div id="bjMainMenu" class="menu-box">
            <button class="term-btn" onclick="window.showBjCreate()">CREATE TABLE</button>
            <p>- OR -</p>
            <input type="text" id="bjJoinInput" class="term-input" placeholder="CODE" maxlength="4">
            <button class="term-btn" onclick="window.joinBjTable()">JOIN TABLE</button>
            <p>- OR -</p>
            <button class="term-btn" onclick="window.startBjSolo()">SOLO PRACTICE</button>
        </div>

        <div id="bjCreateMenu" class="menu-box" style="display:none;">
            <p>SELECT PLAYERS</p>
            <div style="display:flex; gap:10px; justify-content:center;">
                <button class="term-btn" onclick="window.doCreateBj(2)">2P</button>
                <button class="term-btn" onclick="window.doCreateBj(3)">3P</button>
                <button class="term-btn" onclick="window.doCreateBj(4)">4P</button>
            </div>
            <button class="close-btn" style="position:static; margin-top:20px;" onclick="window.backToBjMain()">BACK</button>
        </div>
        
        <div id="bjWaiting" class="menu-box" style="display:none;">
            <p>CODE: <span id="bjWaitCode" style="color:#fff; font-size:20px;"></span></p>
            <p id="bjWaitCount" style="color:yellow;">WAITING FOR PLAYERS...</p>
        </div>
    </div>

    <div id="bjGameInterface" style="display:none; width:100%; height:100%;">
        <div class="bj-container">
            <div class="bj-round-table" id="bjTableSurface">
                
                <div class="bj-dealer-zone">
                    <div class="bj-seat-label">DEALER</div>
                    <div class="bj-hand" id="bjDealerHand"></div>
                    <div style="font-size:10px; margin-top:5px;" id="bjDealerScore"></div>
                </div>
                
                <div id="bjOpponentContainer"></div>

                <div class="bj-seat bj-my-seat" id="bjMySeat">
                    <div class="bj-seat-label">YOU</div>
                    <div class="bj-hand" id="bjMyHand"></div>
                    <div class="bj-seat-status" id="bjMyStatus"></div>
                </div>
            </div>
        </div>

        <div class="bj-hud">
            <div class="bj-info-bar">
                <span>BANK: $<span id="bjBank">1000</span></span>
                <span>BET: $<span id="bjBetAmount">0</span></span>
                <span id="bjGamePhaseMsg" style="color:yellow;">PLACE BET</span>
            </div>

            <div id="bjBetControls" class="bj-actions">
                <div class="bj-chip-rack">
                    <div class="bj-chip" onclick="window.bjAddBet(10)">10</div>
                    <div class="bj-chip" onclick="window.bjAddBet(50)">50</div>
                    <div class="bj-chip" onclick="window.bjAddBet(100)">100</div>
                    <div class="bj-chip" style="color:red; border-color:red;" onclick="window.bjClearBet()">CLR</div>
                </div>
                <button class="term-btn" style="font-size:10px;" onclick="window.bjToggleReady()">READY</button>
            </div>

            <div id="bjActionControls" class="bj-actions" style="display:none;">
                <button class="term-btn" style="background:#0f0; color:#000;" onclick="window.bjHit()">HIT</button>
                <button class="term-btn" style="background:#f00; color:#fff;" onclick="window.bjStand()">STAND</button>
            </div>
        </div>
    </div>
</div>

<div class="overlay" id="modalGameOver" style="background:rgba(0,0,0,0.9); z-index:2000;">
    <h1 style="color:red;">GAME OVER</h1>
    <p id="gameOverText" style="color:#fff; margin-bottom:20px;">SCORE: 0</p>
    <button class="gooner-btn" id="btnRestart" style="font-size:20px;">RESTART</button>
    <button class="close-btn" id="btnExitGame" style="position:static; margin-top:20px;">EXIT</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, onSnapshot, runTransaction } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAoXwDA6KtqSD4yfGprus8C8Mi_--1KwSw",
        authDomain: "funnys-18ff7.firebaseapp.com",
        projectId: "funnys-18ff7",
        storageBucket: "funnys-18ff7.firebasestorage.app",
        messagingSenderId: "368675604960",
        appId: "1:368675604960:web:24c5dcd6a5329c9fd94385",
        measurementId: "G-6PE47RLP8V"
    };
    
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Audio
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(freq=440, type='square', dur=0.1) {
        if(audioCtx.state==='suspended') audioCtx.resume();
        const osc=audioCtx.createOscillator(); const g=audioCtx.createGain();
        osc.type=type; osc.frequency.value=freq; g.gain.value=0.05;
        osc.connect(g); g.connect(audioCtx.destination);
        osc.start(); osc.stop(audioCtx.currentTime+dur);
    }

    let myUid = "local_player"; // Default for solo
    let currentGame = null;
    let isSoloMode = false;

    // Auth
    signInAnonymously(auth).catch(e=>console.log("Offline Mode Possible"));
    onAuthStateChanged(auth, u => { if(u){ myUid=u.uid; document.getElementById('authStatus').innerText="ONLINE"; document.getElementById('authStatus').style.color="#0f0"; }});

    // Menu
    const menuToggle = document.getElementById('menuToggle');
    const menuDropdown = document.getElementById('menuDropdown');
    menuToggle.onclick = (e) => { e.stopPropagation(); menuDropdown.classList.toggle('show'); beep(600); };
    document.onclick = (e) => { if(!menuToggle.contains(e.target)) menuDropdown.classList.remove('show'); };
    
    document.querySelectorAll('[data-game-trigger]').forEach(btn => {
        btn.onclick = () => {
            menuDropdown.classList.remove('show');
            stopAllGames();
            const g = btn.dataset.gameTrigger;
            if(g==='pong') launchOverlay('overlayPong', initPong);
            if(g==='snake') launchOverlay('overlaySnake', initSnake);
            if(g==='runner') launchOverlay('overlayRunner', initRunner);
            if(g==='ttt') launchOverlay('overlayTTT', initTTT);
            if(g==='blackjack') launchOverlay('overlayBlackjack', initBlackjack);
        };
    });

    document.querySelectorAll('[data-close]').forEach(b => b.onclick = () => {
        document.getElementById(b.dataset.close).classList.remove('active');
        stopAllGames();
    });

    function launchOverlay(id, func) { document.getElementById(id).classList.add('active'); if(func) func(); }
    function stopAllGames() {
        if(pongAnim) cancelAnimationFrame(pongAnim);
        if(snakeAnim) clearTimeout(snakeAnim);
        if(runAnim) cancelAnimationFrame(runAnim);
        if(tttUnsub) tttUnsub();
        if(bjUnsub) bjUnsub();
        if(bjSoloTimer) clearTimeout(bjSoloTimer);
        currentGame = null;
    }

    // --- PONG, SNAKE, RUNNER (Condensed) ---
    let pongAnim, pongCtx, ball, p1, p2, pScore, aiScore, pongDiff;
    window.setPongDiff = (d) => { pongDiff = d==='hard'?0.15:0.08; resetBall(); };
    function initPong() { currentGame='pong'; pongCtx=document.getElementById('pongCanvas').getContext('2d'); p1={y:250,h:80}; p2={y:250,h:80}; pScore=0; aiScore=0; pongDiff=0.08; resetBall(); loopPong(); }
    function resetBall(){ ball={x:400,y:300,dx:Math.random()>.5?6:-6,dy:Math.random()*8-4}; }
    function loopPong(){
        if(currentGame!=='pong') return;
        pongCtx.fillStyle='rgba(0,0,0,0.2)'; pongCtx.fillRect(0,0,800,600);
        pongCtx.fillStyle='#f00'; pongCtx.fillRect(20,p1.y,10,p1.h); pongCtx.fillRect(770,p2.y,10,p2.h);
        pongCtx.beginPath(); pongCtx.arc(ball.x,ball.y,8,0,Math.PI*2); pongCtx.fill();
        ball.x+=ball.dx; ball.y+=ball.dy;
        if(ball.y<0||ball.y>600) ball.dy*=-1;
        if((ball.x<30&&ball.y>p1.y&&ball.y<p1.y+p1.h)||(ball.x>770&&ball.y>p2.y&&ball.y<p2.y+p2.h)) { ball.dx=-(ball.dx*1.05); beep(600); }
        if(ball.x<0){ aiScore++; resetBall(); } if(ball.x>800){ pScore++; resetBall(); }
        document.getElementById('pongScore').innerText=`${pScore} : ${aiScore}`;
        p2.y+=(ball.y-p2.h/2-p2.y)*pongDiff;
        pongAnim=requestAnimationFrame(loopPong);
    }
    document.addEventListener('keydown',e=>{ if(currentGame==='pong'){ if(e.key==='w'||e.key==='ArrowUp')p1.y-=30; if(e.key==='s'||e.key==='ArrowDown')p1.y+=30; }});
    document.querySelectorAll('#pongControls .touch-btn').forEach(b=>{ b.onclick=()=>{ if(currentGame==='pong') p1.y+=(b.dataset.key==='up'?-40:40); }});

    let snakeAnim, snakeCtx, snake, food, sDir;
    function initSnake() { currentGame='snake'; snakeCtx=document.getElementById('snakeCanvas').getContext('2d'); snake=[{x:10,y:10}]; sDir='R'; placeFood(); loopSnake(); }
    function placeFood() { food={x:Math.floor(Math.random()*30),y:Math.floor(Math.random()*20)}; }
    function loopSnake() {
        if(currentGame!=='snake') return;
        let h={x:snake[0].x,y:snake[0].y};
        if(sDir==='R')h.x++; if(sDir==='L')h.x--; if(sDir==='U')h.y--; if(sDir==='D')h.y++;
        if(h.x<0||h.x>=30||h.y<0||h.y>=20||snake.some(s=>s.x===h.x&&s.y===h.y)) return triggerGameOver('snake',snake.length-1);
        snake.unshift(h);
        if(h.x===food.x&&h.y===food.y) { placeFood(); beep(600); } else snake.pop();
        snakeCtx.fillStyle='#000'; snakeCtx.fillRect(0,0,600,400);
        snakeCtx.fillStyle='#f00'; snake.forEach(s=>snakeCtx.fillRect(s.x*20,s.y*20,18,18));
        snakeCtx.fillStyle='#fff'; snakeCtx.fillRect(food.x*20,food.y*20,18,18);
        document.getElementById('snakeScoreVal').innerText=snake.length-1;
        snakeAnim=setTimeout(loopSnake,100);
    }
    document.addEventListener('keydown',e=>{ if(currentGame==='snake'){ const k=e.key; if(k.includes('Left'))sDir='L'; if(k.includes('Right'))sDir='R'; if(k.includes('Up'))sDir='U'; if(k.includes('Down'))sDir='D'; }});

    let runAnim, runCtx, runner, obstacles, rScore;
    function initRunner() { currentGame='runner'; runCtx=document.getElementById('runnerCanvas').getContext('2d'); runner={l:1,y:0,j:0,jh:0}; obstacles=[]; rScore=0; loopRunner(); }
    function loopRunner() {
        if(currentGame!=='runner') return;
        if(Math.random()<0.02) obstacles.push({l:Math.floor(Math.random()*3),z:100});
        runCtx.fillStyle='#000'; runCtx.fillRect(0,0,800,400);
        runCtx.strokeStyle='#300'; runCtx.lineWidth=2; runCtx.beginPath(); runCtx.moveTo(400,200); runCtx.lineTo(0,400); runCtx.moveTo(400,200); runCtx.lineTo(800,400); runCtx.stroke();
        obstacles.forEach((o,i)=>{
            o.z-=1.5;
            let s=100/(o.z+10), w=50*s, h=50*s, x=400+(o.l-1)*(400*s)-w/2, y=400-(200*s)-h;
            runCtx.fillStyle='#f00'; runCtx.fillRect(x,y,w,h);
            if(o.z<10 && o.z>0 && o.l===runner.l && runner.jh<10) triggerGameOver('runner',rScore);
            if(o.z<0) { obstacles.splice(i,1); rScore++; document.getElementById('runnerScoreBoard').innerText="SCORE: "+rScore; }
        });
        if(runner.j){ runner.jh+=3; if(runner.jh>50)runner.j=0; } else if(runner.jh>0) runner.jh-=3;
        let px=400+(runner.l-1)*200-30, py=300-runner.jh-80;
        runCtx.fillStyle='#0f0'; runCtx.fillRect(px,py,60,80);
        runAnim=requestAnimationFrame(loopRunner);
    }
    document.getElementById('runnerCanvas').onclick=()=>{if(currentGame==='runner')runner.j=1;};

    /* --- BLACKJACK V3.2 (SOLO + MULTI) --- */
    let bjRoomId=null, bjUnsub=null, bjPlayerState={money:1000,bet:0,ready:false}, bjIsHost=false, bjSoloTimer=null;
    let bjSoloData = null; // Stores local state for Solo

    function initBlackjack() {
        currentGame = 'blackjack'; isSoloMode = false;
        bjPlayerState = { money: 1000, bet: 0, ready: false };
        document.getElementById('bjLobbyContainer').style.display = 'flex';
        document.getElementById('bjGameInterface').style.display = 'none';
        document.getElementById('bjMainMenu').style.display = 'flex';
        document.getElementById('bjCreateMenu').style.display = 'none';
        document.getElementById('bjWaiting').style.display = 'none';
    }

    // -- MENU ACTIONS --
    window.showBjCreate = () => { document.getElementById('bjMainMenu').style.display='none'; document.getElementById('bjCreateMenu').style.display='flex'; };
    window.backToBjMain = () => { document.getElementById('bjCreateMenu').style.display='none'; document.getElementById('bjMainMenu').style.display='flex'; };

    // -- SOLO MODE START --
    window.startBjSolo = () => {
        isSoloMode = true;
        myUid = "PLAYER_1"; // Mock ID
        // Create Mock Data
        bjSoloData = {
            state: 'betting',
            maxPlayers: 1,
            turnIndex: -1,
            deck: [],
            dealerHand: [],
            players: [{ uid: "PLAYER_1", seat: 0, hand: [], bet: 0, ready: false, status: 'waiting', score: 0 }]
        };
        document.getElementById('bjLobbyContainer').style.display='none';
        document.getElementById('bjGameInterface').style.display='flex';
        renderBjState(bjSoloData);
    };

    // -- MULTIPLAYER ACTIONS --
    window.doCreateBj = async (n) => {
        if(!myUid||myUid==="local_player") return alert("Offline");
        const code = Math.floor(1000+Math.random()*9000).toString();
        bjIsHost=true; 
        await setDoc(doc(db,'bj_tables',code), {
            host: myUid, maxPlayers: n, state: 'lobby', turnIndex: -1, deck: [], dealerHand: [],
            players: [{ uid: myUid, seat: 0, hand: [], bet: 0, ready: false, status: 'waiting', score: 0 }]
        });
        enterBjRoom(code);
    };

    window.joinBjTable = async () => {
        const code = document.getElementById('bjJoinInput').value;
        const ref = doc(db,'bj_tables',code);
        const snap = await getDoc(ref);
        if(!snap.exists()) return alert("Invalid Code");
        const d = snap.data();
        if(d.state!=='lobby') return alert("Game in progress");
        if(d.players.length>=d.maxPlayers) return alert("Full");
        
        const newP = [...d.players, { uid: myUid, seat: d.players.length, hand: [], bet: 0, ready: false, status: 'waiting', score: 0 }];
        await updateDoc(ref, { players: newP });
        bjIsHost=false;
        enterBjRoom(code);
    };

    function enterBjRoom(code) {
        bjRoomId = code;
        document.getElementById('bjCreateMenu').style.display='none';
        document.getElementById('bjMainMenu').style.display='none';
        document.getElementById('bjWaiting').style.display='flex';
        document.getElementById('bjWaitCode').innerText=code;
        bjUnsub = onSnapshot(doc(db,'bj_tables',code), s => {
            const data = s.data();
            renderBjState(data);
        });
    }

    // -- SHARED RENDERER (SOLO & MULTI) --
    function renderBjState(data) {
        if(data.state==='lobby') {
            document.getElementById('bjWaitCount').innerText=`PLAYERS: ${data.players.length} / ${data.maxPlayers}`;
            if(data.players.length===data.maxPlayers && bjIsHost && !isSoloMode) updateDoc(doc(db,'bj_tables',bjRoomId),{state:'betting'});
            return;
        }

        // Setup Game View
        document.getElementById('bjLobbyContainer').style.display='none';
        document.getElementById('bjGameInterface').style.display='flex';

        // 1. Dealer
        const dDiv = document.getElementById('bjDealerHand');
        dDiv.innerHTML = '';
        data.dealerHand.forEach((c,i) => {
            const hidden = (i===1 && data.state!=='finished');
            renderCard(c, dDiv, hidden);
        });
        document.getElementById('bjDealerScore').innerText = (data.state==='finished') ? calcHand(data.dealerHand) : '';

        // 2. Players
        const oppDiv = document.getElementById('bjOpponentContainer');
        oppDiv.innerHTML = '';
        const me = data.players.find(p => p.uid === myUid);
        
        data.players.forEach((p, idx) => {
            if(p.uid === myUid) {
                // ME
                const myH = document.getElementById('bjMyHand');
                if(myH.childElementCount !== p.hand.length) { myH.innerHTML=''; p.hand.forEach(c=>renderCard(c,myH)); }
                
                let st = "";
                if(data.state==='betting') st = p.ready ? "READY" : "BETTING...";
                else st = (data.turnIndex===p.seat && data.state==='playing') ? "YOUR TURN!" : p.status;
                
                document.getElementById('bjMyStatus').innerText = `${st} ($${p.bet})`;
                document.getElementById('bjBetAmount').innerText = p.bet;
                
                // Controls
                const betC = document.getElementById('bjBetControls');
                const actC = document.getElementById('bjActionControls');
                const msg = document.getElementById('bjGamePhaseMsg');

                if(data.state==='betting') {
                    betC.style.display = p.ready ? 'none' : 'flex';
                    actC.style.display = 'none';
                    msg.innerText = p.ready ? "WAITING..." : "PLACE BET";
                } else if(data.state==='playing') {
                    betC.style.display='none';
                    if(data.turnIndex===p.seat && !['bust','stand'].includes(p.status)) {
                        actC.style.display='flex';
                        msg.innerText = "YOUR TURN >>>";
                    } else {
                        actC.style.display='none';
                        msg.innerText = "WAITING...";
                    }
                } else if(data.state==='finished') {
                    betC.style.display='none'; actC.style.display='none';
                    const dS = calcHand(data.dealerHand);
                    if(p.score>21) msg.innerText="BUST!";
                    else if(dS>21 || p.score>dS) msg.innerText="WIN!";
                    else if(p.score===dS) msg.innerText="PUSH";
                    else msg.innerText="LOSE";
                    
                    if(bjIsHost || isSoloMode) {
                        if(!bjSoloTimer) bjSoloTimer = setTimeout(()=>resetGame(data), 4000);
                    }
                }
            } else {
                // OPPONENT
                let rIdx = (idx - me.seat + data.maxPlayers) % data.maxPlayers;
                const d = document.createElement('div');
                d.className = `bj-seat seat-pos-${rIdx}`;
                if(data.state==='playing' && data.turnIndex===p.seat) d.classList.add('active-turn');
                
                let h = `<div class="bj-seat-label">P${idx+1}</div><div class="bj-hand">`;
                if(data.state==='betting') h += `<div style="font-size:10px; color:#555;">${p.ready?"[READY]":"[...]"}</div>`;
                else p.hand.forEach(c => {
                    const col = ['♥','♦'].includes(c.suit)?'red':'inherit';
                    h += `<div class="bj-card" style="width:40px; height:56px; font-size:10px; color:${col};"><div>${c.val}</div><div>${c.suit}</div><div>${c.val}</div></div>`;
                });
                h += `</div><div class="bj-seat-status">${p.status}</div>`;
                d.innerHTML = h;
                oppDiv.appendChild(d);
            }
        });

        // Loop Triggers
        if(isSoloMode) soloGameLoop(data);
        else if(bjIsHost) hostGameLoop(data);
    }

    // --- LOGIC: HOST (MULTI) ---
    async function hostGameLoop(data) {
        const ref = doc(db,'bj_tables',bjRoomId);
        // Start Game
        if(data.state==='betting' && data.players.every(p=>p.ready)) {
            const deck=createDeck();
            const dH=[deck.pop(),deck.pop()];
            const pNew=data.players.map(p=>({...p, hand:[deck.pop(),deck.pop()], status:'playing', score:0}));
            pNew.forEach(p=>p.score=calcHand(p.hand));
            await updateDoc(ref, { state:'playing', deck, dealerHand:dH, players:pNew, turnIndex:0 });
        }
        // Turns
        if(data.state==='playing') {
            const cur = data.players[data.turnIndex];
            if(cur.score>21 && cur.status!=='bust') { 
                // Auto Bust update (safety)
                const pUp = [...data.players]; pUp[data.turnIndex].status='bust';
                await updateDoc(ref, { players: pUp });
            }
            if(['bust','stand'].includes(cur.status)) {
                let n = data.turnIndex+1;
                if(n >= data.players.length) runDealer(data, ref);
                else await updateDoc(ref, { turnIndex: n });
            }
        }
    }

    // --- LOGIC: SOLO (LOCAL) ---
    function soloGameLoop(data) {
        // Similar to host but updates local obj and calls render
        if(data.state==='betting' && data.players[0].ready) {
            const deck=createDeck();
            data.dealerHand=[deck.pop(),deck.pop()];
            data.players[0].hand=[deck.pop(),deck.pop()];
            data.players[0].status='playing';
            data.players[0].score=calcHand(data.players[0].hand);
            data.deck=deck;
            data.state='playing';
            data.turnIndex=0;
            renderBjState(data);
        }
        if(data.state==='playing') {
            const p = data.players[0];
            if(p.score>21) p.status='bust';
            if(['bust','stand'].includes(p.status)) {
                // Dealer Turn
                let dScore = calcHand(data.dealerHand);
                while(dScore<17) {
                    data.dealerHand.push(data.deck.pop());
                    dScore=calcHand(data.dealerHand);
                }
                data.state='finished';
                renderBjState(data);
            }
        }
    }

    async function runDealer(data, ref) {
        let h=[...data.dealerHand], d=[...data.deck], s=calcHand(h);
        while(s<17) { h.push(d.pop()); s=calcHand(h); }
        await updateDoc(ref, { state:'finished', dealerHand:h, deck:d });
    }

    async function resetGame(data) {
        bjSoloTimer=null;
        const pR = data.players.map(p=>({...p, hand:[], bet:0, ready:false, status:'waiting', score:0}));
        if(isSoloMode) {
            data.players=pR; data.dealerHand=[]; data.state='betting'; data.turnIndex=-1;
            renderBjState(data);
        } else {
            await updateDoc(doc(db,'bj_tables',bjRoomId), { state:'betting', dealerHand:[], players:pR, turnIndex:-1 });
        }
    }

    // --- ACTIONS ---
    window.bjAddBet = (n) => {
        if(bjPlayerState.money>=n) { bjPlayerState.bet+=n; bjPlayerState.money-=n; updateLocalHUD(); beep(400); }
    };
    window.bjClearBet = () => {
        bjPlayerState.money+=bjPlayerState.bet; bjPlayerState.bet=0; updateLocalHUD();
    };
    function updateLocalHUD() {
        document.getElementById('bjBank').innerText=bjPlayerState.money;
        document.getElementById('bjBetAmount').innerText=bjPlayerState.bet;
    }
    window.bjToggleReady = async () => {
        if(bjPlayerState.bet===0) return alert("Bet First");
        if(isSoloMode) {
            bjSoloData.players[0].bet = bjPlayerState.bet;
            bjSoloData.players[0].ready = true;
            renderBjState(bjSoloData);
        } else {
            await runTransaction(db, async(t)=>{
                const r=doc(db,'bj_tables',bjRoomId); const d=(await t.get(r)).data();
                const i=d.players.findIndex(p=>p.uid===myUid);
                d.players[i].bet=bjPlayerState.bet; d.players[i].ready=true;
                t.update(r,{players:d.players});
            });
        }
    };
    window.bjHit = async () => {
        if(isSoloMode) {
            bjSoloData.players[0].hand.push(bjSoloData.deck.pop());
            bjSoloData.players[0].score=calcHand(bjSoloData.players[0].hand);
            renderBjState(bjSoloData);
        } else {
            await runTransaction(db, async(t)=>{
                const r=doc(db,'bj_tables',bjRoomId); const d=(await t.get(r)).data();
                const i=d.players.findIndex(p=>p.uid===myUid);
                d.players[i].hand.push(d.deck.pop());
                d.players[i].score=calcHand(d.players[i].hand);
                t.update(r,{players:d.players, deck:d.deck});
            });
        }
    };
    window.bjStand = async () => {
        if(isSoloMode) {
            bjSoloData.players[0].status='stand';
            renderBjState(bjSoloData); // Loop will catch this
        } else {
            await runTransaction(db, async(t)=>{
                const r=doc(db,'bj_tables',bjRoomId); const d=(await t.get(r)).data();
                const i=d.players.findIndex(p=>p.uid===myUid);
                d.players[i].status='stand';
                t.update(r,{players:d.players});
            });
        }
    };

    // Utils
    function createDeck(){ const s=['♠','♥','♦','♣'],v=['2','3','4','5','6','7','8','9','10','J','Q','K','A']; let d=[]; for(let S of s)for(let V of v)d.push({suit:S,val:V}); return d.sort(()=>Math.random()-.5); }
    function calcHand(h){ let s=0,a=0; h.forEach(c=>{ if(['J','Q','K'].includes(c.val))s+=10; else if(c.val==='A'){s+=11;a++} else s+=parseInt(c.val); }); while(s>21&&a>0){s-=10;a--} return s; }
    function renderCard(c, el, hidden) {
        const d=document.createElement('div'); d.className='bj-card'+(hidden?' hidden':'');
        if(!hidden){ d.innerHTML=`<div>${c.val}</div><div>${c.suit}</div><div>${c.val}</div>`; d.style.color=['♥','♦'].includes(c.suit)?'red':'inherit'; }
        el.appendChild(d);
    }

    // GAME OVER
    window.triggerGameOver=(g,s)=>{
        stopAllGames(); document.getElementById('gameOverText').innerText="SCORE: "+s;
        document.getElementById('modalGameOver').classList.add('active');
        document.getElementById('btnRestart').onclick=()=>{
            document.getElementById('modalGameOver').classList.remove('active');
            if(g==='snake') initSnake(); if(g==='runner') initRunner(); if(g==='pong') initPong();
        };
    };
    document.getElementById('btnExitGame').onclick=()=>{
        document.getElementById('modalGameOver').classList.remove('active');
        stopAllGames(); document.querySelectorAll('.overlay').forEach(o=>o.classList.remove('active'));
    };

    // TTT LOGIC
    let tttUnsub;
    function initTTT() { currentGame='ttt'; document.getElementById('tttMenu').style.display='flex'; document.getElementById('tttGame').style.display='none'; }
    document.getElementById('btnCreateRoom').onclick=async()=>{
        const c=Math.floor(1000+Math.random()*9000).toString();
        await setDoc(doc(db,'rooms',c),{board:Array(9).fill(null),turn:'X',pX:myUid,pO:null,status:'waiting'});
        joinTTT(c,'X');
    }
    document.getElementById('btnJoinRoom').onclick=async()=>{
        const c=document.getElementById('joinRoomCode').value; const r=doc(db,'rooms',c);
        if((await getDoc(r)).exists()) { await updateDoc(r,{pO:myUid,status:'playing'}); joinTTT(c,'O'); }
    }
    function joinTTT(c,side) {
        document.getElementById('tttMenu').style.display='none'; document.getElementById('tttGame').style.display='flex';
        document.getElementById('displayRoomCode').innerText="CODE: "+c;
        tttUnsub = onSnapshot(doc(db,'rooms',c), d=>{
            const data=d.data();
            data.board.forEach((v,i)=>{ const el=document.getElementById('tttGrid').children[i]; el.innerText=v||''; el.style.color=v==='X'?'#f00':'#fff'; });
            document.getElementById('tttStatus').innerText = data.status==='finished'?"GAME OVER":(data.turn===side?"YOUR TURN":"OPPONENT TURN");
        });
        document.getElementById('tttGrid').onclick=async(e)=>{
            const i=e.target.dataset.idx; if(!i)return;
            await runTransaction(db,async(t)=>{
                const r=doc(db,'rooms',c); const d=(await t.get(r)).data();
                if(d.turn!==side || d.board[i] || d.status!=='playing') return;
                const nb=[...d.board]; nb[i]=side;
                let w=null, wins=[[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
                if(wins.some(win=>nb[win[0]]&&nb[win[0]]==nb[win[1]]&&nb[win[0]]==nb[win[2]])) w=side;
                t.update(r,{board:nb,turn:side==='X'?'O':'X',status:w?'finished':d.status});
            });
        }
    }
</script>
</body>
</html>
