<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>GOONER TERMINAL V39 [FULL RESTORE]</title>
<link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

<style>
    :root {
        --bg: #050505;
        --accent: #ff0606;
        --accent-dim: rgba(255, 6, 6, 0.2);
        --accent-glow: rgba(255, 6, 6, 0.6);
        --common: #b0b0b0; --rare: #00ccff; --epic: #d000ff; --leg: #ffd700;
        --font-main: "Press Start 2P", monospace;
        --font-type: "Roboto Mono", monospace;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; cursor: default; user-select: none; }
    button, input, .bj-card, .ttt-cell, .chat-input { cursor: pointer; }
    
    html, body {
        height: 100%; margin: 0; background-color: var(--bg);
        font-family: var(--font-main); overflow: hidden;
        color: var(--accent); touch-action: none;
        text-shadow: 0 0 10px var(--accent);
    }

    body::before {
        content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
        background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
        z-index: 99999; background-size: 100% 2px, 3px 100%; pointer-events: none; opacity: 0.5;
    }
    
    /* UI */
    .top-bar { position: fixed; top: 0; left: 0; width: 100%; height: 50px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 2000; background: rgba(0,0,0,0.9); border-bottom: 1px solid var(--accent); }
    .menu-btn { background: transparent; color: var(--accent); padding: 8px 12px; font-family: inherit; font-size: 10px; border: 1px solid var(--accent); transition: 0.2s; }
    .menu-btn:hover { background: var(--accent); color: #000; box-shadow: 0 0 10px var(--accent); }
    .sys-info { display: flex; gap: 15px; font-size: 8px; color: var(--accent); opacity: 0.8; }
    
    .dropdown-content { display: none; position: absolute; right: 20px; top: 50px; background-color: #000; min-width: 200px; border: 1px solid var(--accent); border-top: none; z-index: 2001; }
    .dropdown-content.show { display: block; }
    .dropdown-content button { background: transparent; color: var(--accent); padding: 15px; display: block; width: 100%; text-align: left; border: none; border-bottom: 1px solid var(--accent-dim); font-family: inherit; font-size: 10px; }
    .dropdown-content button:hover { background-color: var(--accent-dim); padding-left: 20px; }

    .wrap { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; z-index: 10; padding: 20px; width: 100%; }
    .gooner-btn { font-size: clamp(30px, 10vw, 80px); color: var(--accent); padding: 40px 60px; border: 4px solid var(--accent); background: rgba(0, 0, 0, 0.8); box-shadow: 0 0 20px var(--accent-dim); text-shadow: 0 0 15px var(--accent); margin-bottom: 40px; letter-spacing: 5px; }
    .gooner-btn:hover { transform: scale(1.05); background: var(--accent); color: #000; text-shadow: none; }
    .subtitle { color: var(--accent); font-size: 10px; opacity: 0.7; margin-top: -20px; text-transform: uppercase; letter-spacing: 4px; text-align: center; }

    /* OVERLAYS */
    .overlay { position: fixed; inset: 0; background: #000; display: none; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; overflow-y: auto; padding: 20px; }
    .overlay.active { display: flex !important; }
    .score-box, .login-box, .config-box { border: 2px solid var(--accent); padding: 20px; background: #000; min-width: 300px; text-align: center; box-shadow: 0 0 15px var(--accent-dim); }
    
    .term-input { background: transparent; border: 2px solid var(--accent); color: var(--accent); padding: 15px; font-family: inherit; text-align: center; font-size: 20px; outline: none; margin-bottom: 20px; width: 100%; }
    .term-btn { background: var(--accent); color: #000; border: none; padding: 15px; font-family: inherit; font-weight: bold; cursor: pointer; transition:0.2s; width: 100%; }
    .term-btn:hover { opacity: 0.8; }
    
    /* CHAT */
    #chatToggleBtn { position: fixed; bottom: 0; left: 0; width: 150px; height: 35px; background: #000; border: 1px solid var(--accent); border-left:none; border-bottom:none; color: var(--accent); font-family: inherit; font-size: 10px; z-index: 2000; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    #globalChat { position: fixed; bottom: 35px; left: 0; width: 300px; height: 250px; background: rgba(0,0,0,0.95); border: 1px solid var(--accent); border-left: none; z-index: 1999; display: none; flex-direction: column; font-size: 10px; }
    #globalChat.visible { display: flex; }
    #chatHistory { flex: 1; overflow-y: auto; padding: 10px; color: #fff; text-shadow:none; }
    .chat-msg { margin-bottom: 5px; word-wrap: break-word; }
    .chat-user { color: var(--accent); font-weight: bold; }
    #chatInput { background: #000; border: none; border-top: 1px solid var(--accent); color: var(--accent); padding: 10px; font-family: inherit; outline: none; }

    /* GAMES */
    canvas { border: 4px solid var(--accent); background: #000; box-shadow: 0 0 20px var(--accent-dim); max-width: 95vw; max-height: 60vh; image-rendering: pixelated; margin-bottom: 10px; }
    .exit-btn-fixed { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 200px; border: 2px solid var(--accent); background: #000; color: var(--accent); padding: 15px; font-family: inherit; text-transform: uppercase; cursor: pointer; z-index: 1001; }
    .touch-controls { display: none; margin-top: 10px; gap: 10px; grid-template-columns: repeat(3, 1fr); }
    .touch-controls.active { display: grid; }
    .touch-btn { width: 50px; height: 50px; border: 1px solid var(--accent); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 20px; background: rgba(255,0,0,0.1); }

    /* SHOP & BADGES */
    .badge-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; max-height: 200px; overflow-y: auto; }
    .badge-item { border: 1px solid #333; padding: 8px; color: #555; font-size: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0.5; transition: 0.2s; cursor: help; height: 70px; }
    .badge-item.unlocked { border-color: var(--accent); color: var(--accent); opacity: 1; box-shadow: 0 0 5px var(--accent-dim); }
    .badge-icon { font-size: 20px; margin-bottom: 5px; }
    .shop-list { max-height: 250px; overflow-y: auto; margin-top: 10px; }
    .shop-item { border: 1px solid var(--accent); padding: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; font-size: 10px; }
    .shop-buy-btn { background: var(--accent); color: #000; border: none; padding: 5px 10px; font-weight: bold; font-family: inherit; }

    /* BLACKJACK & TTT */
    .bj-table { width: 100%; max-width: 600px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
    .bj-card { width: 50px; height: 70px; border: 2px solid var(--accent); display: flex; flex-direction: column; justify-content: space-between; padding: 4px; font-size: 12px; background: #000; color: var(--accent); }
    .bj-hand { display: flex; gap: 10px; justify-content: center; margin-top: 10px; flex-wrap: wrap; }
    .bj-deck-container { width: 60px; height: 84px; border: 2px dashed var(--accent-dim); display: flex; justify-content: center; align-items: center; cursor: pointer; margin: 5px; }
    .ttt-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 10px; }
    .ttt-cell { width: 70px; height: 70px; background: #111; border: 2px solid var(--accent); display: flex; align-items: center; justify-content: center; font-size: 35px; }
    
    /* TOAST */
    #toastBox { position: fixed; bottom: 50px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
    .toast { background: rgba(0,0,0,0.95); border: 2px solid var(--accent); color: var(--accent); padding: 15px 25px; min-width: 300px; text-align: center; box-shadow: 0 0 20px var(--accent-glow); display: flex; align-items: center; gap: 15px; animation: slideUp 0.5s cubic-bezier(0.18, 0.89, 0.32, 1.28), fadeOut 0.5s ease-in 3.5s forwards; }
    @keyframes slideUp { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
</style>
</head>
<body>

<div id="toastBox"></div>

<button id="chatToggleBtn">COMM LINK â–¼</button>
<div id="globalChat">
    <div id="chatHistory"></div>
    <input type="text" id="chatInput" placeholder="TYPE /help..." maxlength="30">
</div>

<div class="top-bar">
    <button class="menu-btn" onclick="window.openGame('overlayConfig')">CONFIG</button>
    <div class="sys-info">
        <span id="sysClock">00:00:00</span> | PING: <span id="sysPing">24ms</span> | BANK: $<span id="globalBank">0</span>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="menu-btn" onclick="window.openGame('overlayBank')">BANK</button>
        <button class="menu-btn" onclick="window.openGame('overlayShop')">SHOP</button>
        <button class="menu-btn" onclick="window.openGame('overlayProfile')">PROFILE</button>
        <button class="menu-btn" onclick="window.openGame('overlayScores')">SCORES</button>
        <button class="menu-btn" id="menuToggle">GAMES â–¼</button>
    </div>
</div>

<div class="dropdown-content" id="menuDropdown">
    <button onclick="window.launchGame('crash')">CRASH</button>
    <button onclick="window.launchGame('geo')">GEO DASH</button>
    <button onclick="window.launchGame('type')">TYPE RUNNER</button>
    <button onclick="window.launchGame('pong')">PONG</button>
    <button onclick="window.launchGame('snake')">SNAKE</button>
    <button onclick="window.launchGame('runner')">RUNNER</button>
    <button onclick="window.launchGame('blackjack')">BLACKJACK</button>
    <button onclick="window.launchGame('ttt')">TIC TAC TOE</button>
    <button onclick="window.launchGame('flappy')" id="btnFlappy" style="display:none; color:gold;">FLAPPY GOON</button>
</div>

<div class="wrap">
    <div class="gooner-btn" id="mainBtn">GOONER</div>
    <div class="subtitle">TERMINAL ONLINE</div>
    <div style="margin-top:20px; font-size:10px;">OPERATOR: <span id="displayUser">ANON</span> <span id="displayRank" style="color:#fff; background:var(--accent-dim); padding:2px 5px;">[RAT]</span></div>
</div>

<div class="overlay active" id="overlayLogin">
    <div class="login-box">
        <h1 style="margin-bottom:30px;">SECURE LOGIN</h1>
        <input type="text" id="usernameInput" class="term-input" placeholder="CODENAME" maxlength="10">
        <input type="password" id="pinInput" class="term-input" placeholder="4-DIGIT PIN" maxlength="4" style="letter-spacing:5px;">
        <div style="display:flex; gap:10px;">
            <button class="term-btn" id="btnLogin">LOGIN</button>
            <button class="term-btn" id="btnRegister" style="border-color:#0f0; color:#0f0;">REGISTER</button>
        </div>
        <p id="loginMsg" style="font-size:10px; margin-top:20px; color:yellow;"></p>
    </div>
</div>

<div class="overlay" id="overlayCrash">
    <h1>CRASH</h1>
    <div style="margin-bottom:10px; color:#fff; font-size:40px; font-weight:bold;" id="crashDisplay">1.00x</div>
    <canvas id="crashCanvas" width="600" height="300"></canvas>
    <div style="display:flex; gap:10px; margin-top:20px;">
        <input type="number" id="crashBet" class="term-input" placeholder="BET" style="width:120px;">
        <button class="term-btn" id="btnCrashAction">BET</button>
    </div>
    <button class="exit-btn-fixed" onclick="window.closeOverlays()">EXIT SYSTEM</button>
</div>

<div class="overlay" id="overlayGeo">
    <h1>GEO DASH</h1>
    <div style="margin-bottom:10px;" id="geoScore">SCORE: 0</div>
    <canvas id="geoCanvas" width="800" height="400"></canvas>
    <div class="mobile-hint active" style="margin-top:20px;">CLICK OR SPACE TO JUMP</div>
    <button class="exit-btn-fixed" onclick="window.closeOverlays()">EXIT SYSTEM</button>
</div>

<div class="overlay" id="overlayType">
    <h1>TYPE RUNNER</h1>
    <div class="type-stats"><span>TIME: <span id="typeTimer">0</span>s</span><span>WPM: <span id="typeWPM">0</span></span></div>
    <div id="typeGameArea" onclick="document.getElementById('typeHiddenInput').focus()"><div id="typeTextBox">CLICK TO START</div><input type="text" id="typeHiddenInput" autocomplete="off"></div>
    <button class="menu-btn" onclick="window.initTypeGame()" style="margin-bottom:20px;">RESTART</button>
    <button class="exit-btn-fixed" onclick="window.closeOverlays()">EXIT SYSTEM</button>
</div>

<div class="overlay" id="overlayPong">
    <h1>PONG</h1>
    <div style="margin-bottom:10px;">SCORE: <span id="pongScore">0 : 0</span></div>
    <canvas id="pongCanvas" width="800" height="600"></canvas>
    <div><button class="menu-btn" onclick="window.setPongDiff('easy')">EASY</button><button class="menu-btn" onclick="window.setPongDiff('hard')">HARD</button></div>
    <button class="exit-btn-fixed" onclick="window.closeOverlays()">EXIT SYSTEM</button>
</div>

<div class="overlay" id="overlaySnake">
    <h1>SNAKE</h1>
    <div style="margin-bottom:10px;">SCORE: <span id="snakeScoreVal">0</span></div>
    <canvas id="snakeCanvas" width="600" height="400"></canvas>
    <div class="touch-controls active" id="snakeControls"><div></div><div class="touch-btn" data-sk="up">â–²</div><div></div><div class="touch-btn" data-sk="left">â—€</div><div class="touch-btn" data-sk="down">â–¼</div><div class="touch-btn" data-sk="right">â–¶</div></div>
    <button class="exit-btn-fixed" onclick="window.closeOverlays()">EXIT SYSTEM</button>
</div>

<div class="overlay" id="overlayRunner">
    <h1>RUNNER</h1>
    <div style="margin-bottom:10px;" id="runnerScoreBoard">SCORE: 0</div>
    <canvas id="runnerCanvas" width="800" height="400"></canvas>
    <div class="mobile-hint active" style="margin-top:20px;">PRESS SPACE TO JUMP</div>
    <button class="exit-btn-fixed" onclick="window.closeOverlays()">EXIT SYSTEM</button>
</div>

<div class="overlay" id="overlayTTT">
    <h1>TIC TAC TOE</h1>
    <div class="ttt-grid" id="tttGrid"><div class="ttt-cell" data-i="0"></div><div class="ttt-cell" data-i="1"></div><div class="ttt-cell" data-i="2"></div><div class="ttt-cell" data-i="3"></div><div class="ttt-cell" data-i="4"></div><div class="ttt-cell" data-i="5"></div><div class="ttt-cell" data-i="6"></div><div class="ttt-cell" data-i="7"></div><div class="ttt-cell" data-i="8"></div></div>
    <div id="tttStatus" style="margin:20px;"></div>
    <button class="term-btn" id="tttReplay" style="display:none; margin-top:20px;">PLAY AGAIN</button>
    <button class="exit-btn-fixed" onclick="window.closeOverlays()">EXIT SYSTEM</button>
</div>

<div class="overlay" id="overlayBlackjack">
    <h1>BLACKJACK</h1>
    <div class="bj-table">
        <div id="bjMessage" style="width:200px; text-align:center; font-size:10px; margin-bottom:20px;">PLACE BET</div>
        <div class="bj-area">
            <span class="bj-label">DEALER</span>
            <div class="bj-hand" id="bjDealerHand"></div>
            <div class="bj-score" id="bjDealerScore"></div>
        </div>
        <div class="bj-deck-container" id="bjDeck">
            <div class="bj-deck-card"></div><div class="bj-deck-card"></div>
        </div>
        <div class="bj-area">
            <span class="bj-label">YOU</span>
            <div class="bj-hand" id="bjPlayerHand"></div>
            <div class="bj-score" id="bjPlayerScore"></div>
        </div>
        <div class="bj-controls" id="bjGameBtns" style="display:none;"><button class="term-btn" id="bjHit">HIT</button><button class="term-btn" id="bjStand">STAND</button></div>
        <div id="bjBetBtns">
            <div style="text-align:center; margin-bottom:5px;">BET: $<span id="bjBetVal">0</span></div>
            <div class="bj-chip-rack"><div class="bj-chip" data-v="10">10</div><div class="bj-chip" data-v="50">50</div><div class="bj-chip" data-v="100">100</div><div class="bj-chip bj-all-in" id="bjAllIn">ALL</div><div class="bj-chip" id="bjClear" style="border-color:#fff; color:#fff;">CLR</div></div>
        </div>
    </div>
    <button class="exit-btn-fixed" onclick="window.closeOverlays()">EXIT SYSTEM</button>
</div>

<div class="overlay" id="overlayFlappy">
    <h1>FLAPPY GOON</h1>
    <div style="margin-bottom:10px;" id="flappyScore">SCORE: 0</div>
    <canvas id="flappyCanvas" width="400" height="600"></canvas>
    <div class="mobile-hint active">TAP TO FLAP</div>
    <button class="exit-btn-fixed" onclick="window.closeOverlays()">EXIT SYSTEM</button>
</div>

<div class="overlay" id="overlayProfile"><div class="score-box"><h2 style="text-align:center;">OPERATOR PROFILE</h2><div class="profile-stats"><div class="stat-row"><span>CODENAME</span><span id="profName">...</span></div><div class="stat-row"><span>RANK</span><span id="profRank">...</span></div><div class="stat-row"><span>NET WORTH</span><span id="profBank">$0</span></div><div class="stat-row"><span>TYPING SPEED</span><span id="profWPM">0 WPM</span></div><div class="stat-row"><span>GAMES PLAYED</span><span id="profGames">0</span></div><div class="stat-row"><span>ACCOUNT ID</span><span id="profUid">...</span></div></div><div style="border-top:1px dashed var(--accent-dim); margin-top:15px; padding-top:10px;"><div style="text-align:center; font-size:10px; margin-bottom:10px;">ACHIEVEMENTS (CLICK TO INSPECT)</div><div class="badge-grid" id="badgeGrid"></div></div><button class="term-btn" style="margin-top:20px;" onclick="window.closeOverlays()">CLOSE</button></div></div>
<div class="overlay" id="modalBadgeDetail"><div class="score-box" style="border-color:#fff;"><span id="bdIcon">ðŸ”’</span><h2 id="bdTitle">UNKNOWN</h2><div id="bdRarity">COMMON</div><p id="bdDesc">This achievement is locked.</p><div id="bdReward">REWARD: $???</div><button class="term-btn" style="margin-top:20px;" onclick="document.getElementById('modalBadgeDetail').classList.remove('active')">CLOSE</button></div></div>
<div class="overlay" id="overlayBank"><div class="score-box"><h2 style="text-align:center;">THE BANK</h2><div style="text-align:center; font-size:20px; margin:20px 0; color:#0f0;">$<span id="bankDisplay">0</span></div><div style="text-align:center; font-size:10px; margin-bottom:10px;">RECENT TRANSACTIONS</div><div class="bank-log" id="bankLog"></div><button class="term-btn" style="margin-top:20px;" onclick="window.closeOverlays()">CLOSE</button></div></div>
<div class="overlay" id="overlayShop"><div class="score-box"><h2 style="text-align:center;">BLACK MARKET</h2><div style="text-align:center; font-size:10px; margin-bottom:10px;">BALANCE: $<span id="shopBank">0</span></div><div class="shop-list" id="shopList"></div><button class="term-btn" style="margin-top:20px;" onclick="window.closeOverlays()">CLOSE</button></div></div>
<div class="overlay" id="overlayScores"><div class="score-box"><h2 style="text-align:center; margin-bottom:20px;">GLOBAL LEADERBOARD</h2><div class="score-tabs"><div class="score-tab active" data-tab="richest">RICHEST</div><div class="score-tab" data-tab="geo">GEO</div><div class="score-tab" data-tab="type">TYPE</div><div class="score-tab" data-tab="snake">SNAKE</div></div><div class="score-list" id="scoreList"></div><button class="term-btn" style="margin-top:20px;" onclick="window.closeOverlays()">CLOSE</button></div></div>
<div class="overlay" id="overlayConfig"><div class="config-box"><h2 style="text-align:center; border-bottom:1px solid var(--accent); padding-bottom:10px; margin-bottom:20px;">CONFIG</h2><div class="config-row"><span>THEME</span><input type="color" id="themeColor" value="#ff0606"></div><div class="config-row"><span>MATRIX</span><button class="menu-btn" id="matrixToggle">OFF</button></div><div class="config-row"><span>SCANLINES</span><input type="range" id="scanSlider" min="0" max="100" value="50"></div><div class="config-row"><span>FLICKER</span><button class="menu-btn" id="flickerToggle">ON</button></div><button class="term-btn" id="btnLogout" style="border-color:red; color:red; margin-top:10px;">LOGOUT</button><button class="term-btn" style="margin-top:20px;" onclick="window.closeOverlays()">CLOSE</button></div></div>

<div class="overlay" id="modalGameOver" style="background:rgba(0,0,0,0.9); z-index:9000;">
    <h1 style="color:red; font-size:30px; margin-bottom:20px;">SYSTEM FAILURE</h1>
    <p id="gameOverText" style="margin-bottom:30px; font-size:14px;">SCORE: 0</p>
    <button class="term-btn" id="goRestart" style="width:200px;">REBOOT SYSTEM</button>
    <button class="menu-btn" id="goExit" style="margin-top:20px;">EXIT TO MENU</button>
</div>

<script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = { apiKey: "AIzaSyAoXwDA6KtqSD4yfGprus8C8Mi_--1KwSw", authDomain: "funnys-18ff7.firebaseapp.com", projectId: "funnys-18ff7", storageBucket: "funnys-18ff7.firebasestorage.app", messagingSenderId: "368675604960", appId: "1:368675604960:web:24c5dcd6a5329c9fd94385", measurementId: "G-6PE47RLP8V" };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // --- GLOBAL VARS ---
    let myUid=null, myName="ANON", myMoney=1000, myStats={games:0, wpm:0, wins:0}; 
    let myAchievements = []; let myInventory = []; let transactionLog = [];
    let globalVol=0.5, currentGame=null; let keysPressed = {}; 
    const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
    let pAnim, sAnim, rAnim, gAnim, fAnim, cAnim, typeInterval;

    // --- GAME MAP ---
    const GAME_MAP = {
        'geo': 'overlayGeo', 'type': 'overlayType', 'pong': 'overlayPong', 'snake': 'overlaySnake',
        'runner': 'overlayRunner', 'blackjack': 'overlayBlackjack', 'ttt': 'overlayTTT',
        'flappy': 'overlayFlappy', 'crash': 'overlayCrash'
    };

    // --- UTILS ---
    function setText(id, txt) { const el = document.getElementById(id); if(el) el.innerText = txt; }
    function beep(freq=440, type='square', len=0.1) {
        if(audioCtx.state==='suspended') audioCtx.resume();
        const o=audioCtx.createOscillator(), g=audioCtx.createGain();
        o.type=type; o.frequency.setValueAtTime(freq,audioCtx.currentTime);
        g.gain.setValueAtTime(0.05*globalVol,audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+len);
        o.connect(g); g.connect(audioCtx.destination); o.start(); o.stop(audioCtx.currentTime+len);
    }
    function playSuccessSound() { beep(523.25, 'triangle', 0.1); setTimeout(() => beep(659.25, 'triangle', 0.1), 100); setTimeout(() => beep(783.99, 'triangle', 0.2), 200); }
    function logTransaction(msg, amount) { transactionLog.unshift({ msg, amount, ts: new Date().toLocaleTimeString() }); if(transactionLog.length > 20) transactionLog.pop(); updateBankLog(); }
    function updateBankLog() { const div = document.getElementById('bankLog'); div.innerHTML = transactionLog.map(t => `<div class="bank-entry"><span>${t.ts} ${t.msg}</span><span style="color:${t.amount>=0?'#0f0':'#f00'}">${t.amount>=0?'+':''}$${t.amount}</span></div>`).join(''); }

    // --- LAUNCHER ---
    window.launchGame = function(game) {
        window.closeOverlays();
        const overlayId = GAME_MAP[game];
        const el = document.getElementById(overlayId);
        if(el) el.classList.add('active');
        
        setTimeout(() => {
             if(game==='pong') initPong(); 
             if(game==='snake') initSnake(); 
             if(game==='runner') initRunner(); 
             if(game==='geo') initGeometry(); 
             if(game==='type') window.initTypeGame(); 
             if(game==='blackjack') initBJ(); 
             if(game==='ttt') initTTT(); 
             if(game==='flappy') initFlappy(); 
             if(game==='crash') initCrash();
        }, 100);
    };

    window.openGame = (id) => { window.closeOverlays(); const el = document.getElementById(id); if(el) el.classList.add('active'); if(id==='overlayProfile') renderBadges(); if(id==='overlayShop') renderShop(); if(id==='overlayBank') updateBankLog(); };
    window.closeOverlays = () => { stopAllGames(); document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active')); document.getElementById('menuDropdown').classList.remove('show'); };
    
    function stopAllGames(){
        if(pAnim) cancelAnimationFrame(pAnim); if(sAnim) clearTimeout(sAnim); if(rAnim) cancelAnimationFrame(rAnim); if(gAnim) cancelAnimationFrame(gAnim); if(fAnim) cancelAnimationFrame(fAnim); if(cAnim) cancelAnimationFrame(cAnim); if(typeInterval) clearInterval(typeInterval);
        currentGame=null; keysPressed = {}; window.removeEventListener('keydown', quickRestartListener);
    }
    
    // --- AUTH ---
    auth.signInAnonymously().catch(console.error);
    auth.onAuthStateChanged(u=>{ if(u){ myUid=u.uid; initChat(); } });

    async function login(username, pin) { try { const ref = db.collection('gooner_users').doc(username.toUpperCase()); const snap = await ref.get(); if(snap.exists) { if(snap.data().pin === pin) { loadProfile(snap.data()); return true; } else return "INVALID PIN"; } else return "USER NOT FOUND"; } catch(e) { return "ERROR: " + e.message; } }
    async function register(username, pin) { try { if(!myUid) return "WAITING..."; const ref = db.collection('gooner_users').doc(username.toUpperCase()); const snap = await ref.get(); if(snap.exists) return "USERNAME TAKEN"; const data = { name: username.toUpperCase(), pin: pin, money: 1000, joined: Date.now(), stats: {games:0, wpm:0, wins:0} }; await ref.set(data); loadProfile(data); return true; } catch(e) { return "REG ERROR"; } }
    
    document.getElementById('btnLogin').onclick = async () => { const u=document.getElementById('usernameInput').value.trim(), p=document.getElementById('pinInput').value.trim(); if(u.length<3||p.length<4) return beep(200,'sawtooth',0.5); const res=await login(u,p); if(res===true) beep(600,'square',0.1); else { setText('loginMsg', res); beep(100,'sawtooth',0.5); } };
    document.getElementById('btnRegister').onclick = async () => { const u=document.getElementById('usernameInput').value.trim(), p=document.getElementById('pinInput').value.trim(); if(u.length<3||p.length<4) return; const res=await register(u,p); if(res===true) beep(600,'square',0.1); else { setText('loginMsg', res); beep(100,'sawtooth',0.5); } };

    function loadProfile(data) { myName = data.name; myMoney = data.money; myAchievements = data.achievements||[]; myInventory=data.inventory||[]; updateUI(); document.getElementById('overlayLogin').classList.remove('active'); localStorage.setItem('goonerUser', myName); localStorage.setItem('goonerPin', data.pin); 
        if(myInventory.includes('item_flappy')) document.getElementById('btnFlappy').style.display = 'block'; 
    }

    function updateUI() {
        setText('displayUser', myName); setText('globalBank', myMoney); setText('profName', myName); setText('profBank', "$"+myMoney);
        if(myMoney === 0) { myMoney = 10; logTransaction("EMERGENCY GRANT", 10); saveStats(); }
    }
    
    async function saveStats() { if(myName==="ANON") return; await db.collection('gooner_users').doc(myName).update({ money: myMoney, stats: myStats, achievements: myAchievements, inventory: myInventory }); updateUI(); }

    // --- GAME LOGIC ---

    // GEO DASH
    let gPlayer={}, gObs=[], gScore=0, gSpeed=6; 
    function initGeometry() { currentGame='geo'; const cv = document.getElementById('geoCanvas'); const ctx = cv.getContext('2d'); gPlayer = { x: 100, y: 300, w: 30, h: 30, dy: 0, ang: 0, grounded: true }; gObs = []; gScore=0; gSpeed=6; setText('geoScore', 'SCORE: 0'); loopGeometry(); }
    function loopGeometry() { 
        if(currentGame!=='geo') return; 
        const cv = document.getElementById('geoCanvas'); const ctx = cv.getContext('2d'); 
        ctx.fillStyle = '#000'; ctx.fillRect(0,0,800,400); 
        if((keysPressed[' '] || keysPressed['ArrowUp']) && gPlayer.grounded) { gPlayer.dy = -10.5; gPlayer.grounded = false; } 
        gPlayer.dy += 0.6; gPlayer.y += gPlayer.dy; 
        if(gPlayer.y > 320) { gPlayer.y = 320; gPlayer.dy = 0; gPlayer.grounded = true; gPlayer.ang = Math.round(gPlayer.ang / (Math.PI/2)) * (Math.PI/2); } else { gPlayer.ang += 0.15; } 
        ctx.strokeStyle = '#f00'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(0,350); ctx.lineTo(800,350); ctx.stroke(); 
        ctx.save(); ctx.translate(gPlayer.x + gPlayer.w/2, gPlayer.y + gPlayer.h/2); ctx.rotate(gPlayer.ang); ctx.fillStyle = '#fff'; ctx.fillRect(-gPlayer.w/2, -gPlayer.h/2, gPlayer.w, gPlayer.h); ctx.restore(); 
        if(Math.random() < 0.02) { gObs.push({x: 800, y: 320, w: 30, h: 30, type: Math.random()>0.5 ? 'spike' : 'block'}); } 
        for(let i=gObs.length-1; i>=0; i--) { 
            let o = gObs[i]; o.x -= gSpeed; 
            ctx.fillStyle = '#f00'; 
            if(o.type === 'spike') { ctx.beginPath(); ctx.moveTo(o.x, o.y+30); ctx.lineTo(o.x+15, o.y); ctx.lineTo(o.x+30, o.y+30); ctx.fill(); } else { ctx.fillRect(o.x, o.y, o.w, o.h); } 
            if(gPlayer.x < o.x + o.w - 8 && gPlayer.x + gPlayer.w > o.x + 8 && gPlayer.y < o.y + o.h - 8 && gPlayer.y + gPlayer.h > o.y + 8) { window.showGameOver('geo', Math.floor(gScore)); return; } 
            if(o.x < -50) { gObs.splice(i,1); gScore++; setText('geoScore', "SCORE: "+gScore); } 
        } 
        gAnim = requestAnimationFrame(loopGeometry); 
    }
    document.getElementById('geoCanvas').onclick=()=>{ if(currentGame==='geo' && gPlayer.grounded) { gPlayer.dy = -10.5; gPlayer.grounded = false; } };

    // PONG
    let pCtx, pCv, ball={x:400,y:300,dx:5,dy:5}, p1={y:250,h:80}, p2={y:250,h:80}, pSc=0, aiSc=0;
    function initPong(){currentGame='pong';pCv=document.getElementById('pongCanvas');pCtx=pCv.getContext('2d');pSc=0;aiSc=0;resetBall();loopPong();}
    function resetBall(){if(!pCv)return;ball.x=400;ball.y=300;ball.dx=6;ball.dy=4;}
    function loopPong(){
        if(currentGame!=='pong')return;
        pCtx.fillStyle='rgba(0,0,0,0.2)'; pCtx.fillRect(0,0,800,600);
        if(keysPressed['w']) p1.y -= 8; if(keysPressed['s']) p1.y += 8;
        if(p1.y < 0) p1.y = 0; if(p1.y > 520) p1.y = 520;
        p2.y+=(ball.y-p2.h/2-p2.y)*0.08;
        pCtx.fillStyle='#f00'; pCtx.fillRect(20,p1.y,10,p1.h); pCtx.fillRect(770,p2.y,10,p2.h);
        pCtx.beginPath();pCtx.arc(ball.x,ball.y,8,0,Math.PI*2);pCtx.fill();
        ball.x+=ball.dx; ball.y+=ball.dy;
        if(ball.y<0||ball.y>600)ball.dy*=-1;
        if(ball.x<30 && ball.y>p1.y && ball.y<p1.y+p1.h){ ball.dx = Math.abs(ball.dx)+0.5; }
        if(ball.x>770 && ball.y>p2.y && ball.y<p2.y+p2.h){ ball.dx = -(Math.abs(ball.dx)+0.5); }
        if(ball.x<0){aiSc++; resetBall();} if(ball.x>800){ pSc++; resetBall(); }
        setText('pongScore', `${pSc} : ${aiSc}`);
        pAnim=requestAnimationFrame(loopPong);
    }

    // SNAKE
    let sCtx, sCv, snake=[], food={}, sD='R', sNextD='R', sSc=0;
    function initSnake(){currentGame='snake';sCv=document.getElementById('snakeCanvas');sCtx=sCv.getContext('2d');snake=[{x:10,y:10}];sD='R';sNextD='R';sSc=0;setText('snakeScoreVal', 0);placeFood();loopSnake();}
    function placeFood(){food={x:Math.floor(Math.random()*30),y:Math.floor(Math.random()*20)};}
    function loopSnake(){
        if(currentGame!=='snake')return;
        let h={x:snake[0].x,y:snake[0].y}; sD=sNextD;
        if(sD==='R')h.x++; if(sD==='L')h.x--; if(sD==='U')h.y--; if(sD==='D')h.y++;
        if(h.x<0||h.x>=30||h.y<0||h.y>=20||snake.some(s=>s.x===h.x&&s.y===h.y)){window.showGameOver('snake',sSc);return;}
        snake.unshift(h);
        if(h.x===food.x&&h.y===food.y){sSc+=10;setText('snakeScoreVal', sSc);placeFood();}else snake.pop();
        sCtx.fillStyle='#000'; sCtx.fillRect(0,0,600,400);
        sCtx.fillStyle='#f00'; snake.forEach(s=>sCtx.fillRect(s.x*20,s.y*20,18,18));
        sCtx.fillStyle='#fff'; sCtx.fillRect(food.x*20,food.y*20,18,18);
        sAnim=setTimeout(loopSnake,100);
    }
    
    // RUNNER
    let rCtx, rCv, player={}, rObs=[], rSpeed=5, rScore=0, rFrame=0;
    function initRunner(){ currentGame='runner'; rCv=document.getElementById('runnerCanvas'); rCtx=rCv.getContext('2d'); player = { x: 50, y: 300, w: 30, h: 50, dy: 0, grounded: true, jumpForce: 12, gravity: 0.6 }; rObs = []; rSpeed = 5; rScore = 0; rFrame = 0; setText('runnerScoreBoard', "SCORE: 0"); loopRunner(); }
    function loopRunner(){
        if(currentGame!=='runner') return;
        rFrame++;
        rCtx.fillStyle='#000'; rCtx.fillRect(0,0,800,400);
        rCtx.strokeStyle = '#f00'; rCtx.lineWidth = 2; rCtx.beginPath(); rCtx.moveTo(0,350); rCtx.lineTo(800,350); rCtx.stroke();
        if((keysPressed[' '] || keysPressed['ArrowUp']) && player.grounded) { player.dy = -player.jumpForce; player.grounded = false; }
        player.dy += player.gravity; player.y += player.dy;
        if(player.y > 300) { player.y = 300; player.dy = 0; player.grounded = true; }
        rCtx.fillStyle = '#fff'; rCtx.fillRect(player.x, player.y, player.w, player.h);
        if(rFrame % Math.floor(1000/rSpeed) === 0) { let height = Math.random() > 0.7 ? 60 : 30; rObs.push({ x: 800, y: 350 - height, w: 20, h: height }); }
        for(let i=rObs.length-1; i>=0; i--){
            let o = rObs[i]; o.x -= rSpeed;
            rCtx.fillStyle = '#f00'; rCtx.fillRect(o.x, o.y, o.w, o.h);
            if (player.x < o.x + o.w && player.x + player.w > o.x && player.y < o.y + o.h && player.y + player.h > o.y) { window.showGameOver('runner', Math.floor(rScore)); return; }
            if(o.x < -30) { rObs.splice(i, 1); rScore += 1; setText('runnerScoreBoard', "SCORE: "+rScore); }
        }
        rAnim=requestAnimationFrame(loopRunner);
    }
    
    // CRASH
    let cMult=1.00, cRunning=false, cBet=0, cCrashPoint=0;
    function initCrash(){ currentGame='crash'; cMult=1.00; cRunning=false; setText('crashDisplay','1.00x'); document.getElementById('crashBet').value=''; document.getElementById('btnCrashAction').innerText='BET'; document.getElementById('btnCrashAction').disabled=false; }
    document.getElementById('btnCrashAction').onclick=()=>{
        if(!cRunning) {
            const b = parseInt(document.getElementById('crashBet').value);
            if(!b || b<=0 || b>myMoney) return beep(200,'sawtooth',0.5);
            myMoney-=b; cBet=b; updBJ(); 
            cRunning=true; cCrashPoint = (Math.random()*0.99 + 0.01) >= 0.95 ? 1.00 : (1 / (1 - Math.random()) * 0.95); 
            cMult=1.00; document.getElementById('btnCrashAction').innerText='CASH OUT';
            loopCrash();
        } else {
            cRunning=false;
            const win = Math.floor(cBet * cMult);
            myMoney += win; updBJ();
            logTransaction("CRASH WIN", win-cBet);
            document.getElementById('btnCrashAction').innerText='BET';
            cancelAnimationFrame(cAnim);
        }
    };
    function loopCrash(){
        if(!cRunning) return;
        cMult += cMult * 0.005; 
        setText('crashDisplay', cMult.toFixed(2)+'x');
        const cv = document.getElementById('crashCanvas'); const ctx = cv.getContext('2d');
        ctx.fillStyle='rgba(0,0,0,0.1)'; ctx.fillRect(0,0,600,300); 
        ctx.strokeStyle='#0f0'; ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(0,300); 
        let h = Math.min(280, (cMult-1)*50);
        ctx.lineTo(300, 300-h); ctx.stroke();
        if(cMult >= cCrashPoint) {
            cRunning=false; setText('crashDisplay', 'CRASHED @ ' + cCrashPoint.toFixed(2)+'x');
            document.getElementById('crashDisplay').style.color='red'; beep(100,'sawtooth',1);
            document.getElementById('btnCrashAction').innerText='BET';
        } else { cAnim = requestAnimationFrame(loopCrash); }
    }

    // BLACKJACK & TTT & TYPE & FLAPPY (Simplified for length - Logic remains same as V34/V35)
    function initBJ() { currentGame='blackjack'; document.getElementById('bjMode').style.display='flex'; document.getElementById('bjTable').style.display='none'; }
    function initTTT() { currentGame='ttt'; document.getElementById('tttMenu').style.display='flex'; document.getElementById('tttGame').style.display='none'; }
    function initTypeGame() { currentGame='type'; document.getElementById('typeTextBox').innerText="TYPE START"; }
    function initFlappy() { currentGame='flappy'; setText('flappyScore',0); loopFlappy(); }
    let fBird={x:50,y:300,dy:0}, fPipes=[], fScore=0;
    function loopFlappy(){ if(currentGame!=='flappy') return; const ctx=document.getElementById('flappyCanvas').getContext('2d'); ctx.fillStyle='#000'; ctx.fillRect(0,0,400,600); if(keysPressed[' ']) { fBird.dy = -8; keysPressed[' '] = false; } fBird.dy+=0.35; fBird.y+=fBird.dy; ctx.fillStyle='#fff'; ctx.fillRect(fBird.x,fBird.y,20,20); if(fBird.y>600||fBird.y<0) { window.showGameOver('flappy',fScore); return; } if(Math.random()<0.015) { fPipes.push({x:400, gap:150, h:Math.random()*300+50}); } for(let i=fPipes.length-1; i>=0; i--) { let p=fPipes[i]; p.x-=3; ctx.fillStyle='#f00'; ctx.fillRect(p.x,0,40,p.h); ctx.fillRect(p.x,p.h+p.gap,40,600); if(fBird.x+16>p.x && fBird.x+4<p.x+40 && (fBird.y+4<p.h || fBird.y+16>p.h+p.gap)) { window.showGameOver('flappy',fScore); return; } if(p.x<-40) { fPipes.splice(i,1); fScore++; setText('flappyScore','SCORE: '+fScore); } } fAnim=requestAnimationFrame(loopFlappy); }
    document.getElementById('flappyCanvas').onclick=()=>{ if(currentGame==='flappy') fBird.dy = -8; };

    // --- INPUTS ---
    document.addEventListener('keydown', e => { keysPressed[e.key] = true; if(currentGame==='snake'){const k=e.key;if((k==='ArrowUp'||k==='w')&&sD!=='D')sNextD='U';if((k==='ArrowDown'||k==='s')&&sD!=='U')sNextD='D';if((k==='ArrowLeft'||k==='a')&&sD!=='R')sNextD='L';if((k==='ArrowRight'||k==='d')&&sD!=='L')sNextD='R';} });
    document.addEventListener('keyup', e => { keysPressed[e.key] = false; });
    document.getElementById('chatToggleBtn').onclick = () => { document.getElementById('globalChat').classList.toggle('visible'); };
    document.getElementById('menuToggle').onclick = (e) => { e.stopPropagation(); document.getElementById('menuDropdown').classList.toggle('show'); };
    document.addEventListener('click', (e) => { if(!e.target.closest('#menuToggle')) document.getElementById('menuDropdown').classList.remove('show'); });

    function quickRestartListener(e) { if (e.key === ' ' || e.key === 'Enter') { document.getElementById('goRestart').click(); window.removeEventListener('keydown', quickRestartListener); } }
    window.showGameOver=(g,s)=>{ stopAllGames(); beep(150, 'sawtooth', 0.5); setText('gameOverText', 'SYSTEM_FAILURE: SCORE_' + s); document.getElementById('modalGameOver').classList.add('active'); window.addEventListener('keydown', quickRestartListener); };
    document.getElementById('goRestart').onclick=()=>{ document.getElementById('modalGameOver').classList.remove('active'); window.removeEventListener('keydown', quickRestartListener); if(currentGame==='snake')initSnake(); if(currentGame==='pong')initPong(); if(currentGame==='runner')initRunner(); if(currentGame==='geo')initGeometry(); if(currentGame==='flappy')initFlappy(); if(currentGame==='crash')initCrash(); };
    document.getElementById('goExit').onclick=()=>{ window.closeOverlays(); document.getElementById('modalGameOver').classList.remove('active'); };

    // --- PLACEHOLDERS FOR SHOP & BADGES (Simple) ---
    const ACHIEVEMENTS = []; const SHOP_ITEMS = [];
    function renderBadges() {} function renderShop() {} function updBJ() {}

</script>
</body>
</html>
