<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Multiplayer Tic Tac Toe</title>
<style>
  body { background:#000; color:#f06; font-family: monospace; text-align:center; }
  #board { display:grid; grid-template-columns: repeat(3, 100px); gap:5px; margin:20px auto; }
  .cell {
    width: 100px; height: 100px; background:#111; border: 2px solid #f06; font-size:60px;
    display:flex; align-items:center; justify-content:center; cursor: default; user-select:none;
  }
  #status { margin-top:10px; font-size:18px; }
  #joinSection { margin-top:50px; }
  input, button {
    font-size:18px; padding:10px; margin: 10px 5px; border-radius:6px; border:none;
    background:#f06; color:#000; cursor:pointer;
  }
  button:disabled { background:#555; cursor:not-allowed; }
</style>
</head>
<body>
<h1>Multiplayer Tic Tac Toe</h1>

<div id="joinSection">
  <button id="createBtn">Create New Game</button>
  <input type="text" id="roomInput" placeholder="Enter room code" maxlength="6" />
  <button id="joinBtn">Join Game</button>
  <div id="roomInfo"></div>
</div>

<div id="gameSection" style="display:none;">
  <div id="board"></div>
  <div id="status">Connecting...</div>
  <button id="resetBtn" style="margin-top: 20px; display:none;">Reset Game</button>
</div>

<script>
  const createBtn = document.getElementById('createBtn');
  const joinBtn = document.getElementById('joinBtn');
  const roomInput = document.getElementById('roomInput');
  const roomInfo = document.getElementById('roomInfo');
  const joinSection = document.getElementById('joinSection');

  const gameSection = document.getElementById('gameSection');
  const boardEl = document.getElementById('board');
  const statusEl = document.getElementById('status');
  const resetBtn = document.getElementById('resetBtn');

  let ws;
  let playerId = null;
  let gameState = null;

  createBtn.onclick = async () => {
    createBtn.disabled = true;
    roomInfo.textContent = "Creating room...";
    const res = await fetch('https://aiworker.thefoxsss6969.workers.dev/tictactoe/create');
    const code = await res.text();
    roomInfo.textContent = `Room created! Code: ${code}`;
    roomInput.value = code;
    createBtn.disabled = false;
  };

  joinBtn.onclick = () => {
    const code = roomInput.value.trim().toUpperCase();
    if (!code) {
      alert("Please enter a room code");
      return;
    }
    startGame(code);
  };

  function startGame(roomCode) {
    joinSection.style.display = 'none';
    gameSection.style.display = 'block';
    statusEl.textContent = "Connecting to room " + roomCode + "...";

    ws = new WebSocket(`wss://aiworker.thefoxsss6969.workers.dev/tictactoe/join/${roomCode}`);

    ws.onopen = () => statusEl.textContent = "Connected. Waiting for opponent...";

    ws.onmessage = (e) => {
      let data;
      try {
        data = JSON.parse(e.data);
      } catch { return; }

      if(data.type === 'init') {
        playerId = data.playerId;
        gameState = data.state;
        renderBoard();
        updateStatus();
      } else if(data.type === 'update' || data.type === 'sync') {
        gameState = data.state;
        renderBoard();
        updateStatus();
      } else if(data.type === 'playerLeft') {
        statusEl.textContent = "Opponent left. Waiting for new opponent...";
        resetBtn.style.display = 'none';
      } else if(data.type === 'error') {
        alert("Error: " + data.message);
        ws.close();
      }
    };

    ws.onclose = () => {
      statusEl.textContent = "Disconnected from server";
      resetBtn.style.display = 'none';
      boardEl.innerHTML = '';
      joinSection.style.display = 'block';
      gameSection.style.display = 'none';
    };
  }

  function renderBoard() {
    boardEl.innerHTML = '';
    gameState.board.forEach((cell, idx) => {
      const cellDiv = document.createElement('div');
      cellDiv.classList.add('cell');
      cellDiv.textContent = cell || '';
      if (!cell && !gameState.gameOver && gameState.currentPlayer === playerId) {
        cellDiv.style.cursor = 'pointer';
        cellDiv.onclick = () => {
          ws.send(JSON.stringify({ type: 'move', playerId, index: idx }));
        };
      }
      boardEl.appendChild(cellDiv);
    });
  }

  function updateStatus() {
    if (gameState.sessions?.length < 2) {
      statusEl.textContent = "Waiting for opponent...";
      resetBtn.style.display = 'none';
      return;
    }
    if (gameState.gameOver) {
      let msg;
      if (gameState.winner === 'draw') msg = "It's a draw!";
      else if (gameState.winner === (playerId === 0 ? 'X' : 'O')) msg = "You win!";
      else msg = "You lose!";
      statusEl.textContent = msg;
      resetBtn.style.display = 'inline-block';
    } else {
      resetBtn.style.display = 'none';
      statusEl.textContent = gameState.currentPlayer === playerId ? "Your turn" : "Opponent's turn";
    }
  }

  resetBtn.onclick = () => {
    if(ws && ws.readyState === WebSocket.OPEN)
      ws.send(JSON.stringify({ type: 'reset' }));
  };
</script>
</body>
</html>

